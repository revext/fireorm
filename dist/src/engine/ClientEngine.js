"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const firestore_1 = require("@firebase/firestore");
class ClientEngine {
    constructor(app) {
        this.transaction = null;
        this.batch = null;
        this.listeners = {};
        this.inTransaction = false;
        this.app = app;
        this.db = (0, firestore_1.getFirestore)(app);
    }
    save(model) {
        const blueprint = model.getBlueprint();
        return (new Promise((resolve, reject) => {
            try {
                // if model has id, then update firestore document otherwise add firestore document to collection
                if (model.id) {
                    if (this.transaction) {
                        this.transaction.set((0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), model.id), model.toJson());
                        resolve(model);
                    }
                    else if (this.batch) {
                        this.batch.set((0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), model.id), model.toJson());
                        resolve(model);
                    }
                    else {
                        (0, firestore_1.setDoc)((0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), model.id)
                            .withConverter(this.getConverter(blueprint.constructorFunction)), model)
                            .then(() => {
                            resolve(model);
                        });
                    }
                }
                else {
                    if (this.transaction) {
                        const docRef = (0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute());
                        model.id = docRef.id;
                        this.transaction.set(docRef, model.toJson());
                        resolve(model);
                    }
                    else if (this.batch) {
                        const docRef = (0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute());
                        model.id = docRef.id;
                        this.batch.set(docRef, model.toJson());
                        resolve(model);
                    }
                    else {
                        let docRef = (0, firestore_1.doc)((0, firestore_1.collection)(this.db, blueprint.buildCollectionRoute()))
                            .withConverter(this.getConverter(blueprint.constructorFunction));
                        model.id = docRef.id;
                        (0, firestore_1.setDoc)(docRef, model).then(() => {
                            resolve(model);
                        });
                    }
                }
            }
            catch (e) {
                reject(e);
            }
        }));
    }
    saveMany(models) {
        return (new Promise((resolve, reject) => {
            try {
                const promises = models.map(model => this.save(model));
                Promise.all(promises).then(resolve);
            }
            catch (e) {
                reject(e);
            }
        }));
    }
    update(blueprint, id, data) {
        return (new Promise((resolve, reject) => {
            try {
                if (this.transaction) {
                    this.transaction.update((0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), id), data);
                    resolve();
                }
                else if (this.batch) {
                    this.batch.update((0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), id), data);
                    resolve();
                }
                else {
                    (0, firestore_1.updateDoc)((0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), id)
                        .withConverter(this.getConverter(blueprint.constructorFunction)), data)
                        .then(() => {
                        resolve();
                    });
                }
            }
            catch (e) {
                reject(e);
            }
        }));
    }
    async updateMany(blueprint, ids, data) {
        return (new Promise((resolve, reject) => {
            try {
                const promises = ids.map(id => this.update(blueprint, id, data));
                Promise.all(promises).then(() => resolve());
            }
            catch (e) {
                reject(e);
            }
        }));
    }
    async load(blueprint, id) {
        if (this.batch) {
            throw new Error('Cannot load in batch');
        }
        const query = (0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), id).withConverter(this.getConverter(blueprint.constructorFunction));
        if (this.transaction) {
            return (await this.transaction.get(query)).data();
        }
        else {
            return (await (0, firestore_1.getDoc)(query)).data();
        }
    }
    async loadMany(blueprint, ids) {
        if (this.batch || this.transaction) {
            throw new Error('Cannot loadMany in batch');
        }
        const docRefs = ids.map(id => (0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), id).withConverter(this.getConverter(blueprint.constructorFunction)));
        const promises = [];
        docRefs.forEach(dRef => {
            if (this.transaction) {
                promises.push(this.transaction.get(dRef));
            }
            else {
                promises.push((0, firestore_1.getDoc)(dRef));
            }
        });
        return (await Promise.all(promises)).map(d => d.data());
    }
    async loadCollection(blueprint) {
        if (this.batch) {
            throw new Error('Cannot loadCollection in batch or transaction');
        }
        const query = (0, firestore_1.collection)(this.db, blueprint.buildCollectionRoute()).withConverter(this.getConverter(blueprint.constructorFunction));
        return (await (0, firestore_1.getDocs)(query)).docs.map(d => d.data());
    }
    //TODO other paramters, like limit, startAt, etc...
    async query(blueprint, queryParams) {
        if (this.batch) {
            throw new Error('Cannot query in batch or transaction');
        }
        const collectionRef = (0, firestore_1.collection)(this.db, blueprint.buildCollectionRoute()).withConverter(this.getConverter(blueprint.constructorFunction));
        const wheres = [];
        queryParams.forEach(param => {
            wheres.push((0, firestore_1.where)(param.field, param.op, param.value));
        });
        return (await (0, firestore_1.getDocs)((0, firestore_1.query)(collectionRef, ...wheres))).docs.map(d => d.data());
    }
    async queryAsGroup(blueprint, queryParams) {
        if (this.batch) {
            throw new Error('Cannot queryAsGroup in batch or transaction');
        }
        const collectionRef = (0, firestore_1.collectionGroup)(this.db, blueprint.getSubCollectionName()).withConverter(this.getConverter(blueprint.constructorFunction));
        const wheres = [];
        queryParams.forEach(param => {
            wheres.push((0, firestore_1.where)(param.field, param.op, param.value));
        });
        return (await (0, firestore_1.getDocs)((0, firestore_1.query)(collectionRef, ...wheres))).docs.map(d => d.data());
    }
    snapshotListener(name, blueprint, id, onRecieve, onError) {
        this.listeners[name] = (0, firestore_1.onSnapshot)((0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), id).withConverter(this.getConverter(blueprint.constructorFunction)), (snapshot) => {
            onRecieve(snapshot.data());
        }, (error) => onError(error));
    }
    snapshotListenerMany(name, blueprint, queryParams, onRecieve, onError) {
        const collectionRef = (0, firestore_1.collection)(this.db, blueprint.buildCollectionRoute()).withConverter(this.getConverter(blueprint.constructorFunction));
        const wheres = [];
        queryParams.forEach(param => {
            wheres.push((0, firestore_1.where)(param.field, param.op, param.value));
        });
        this.listeners[name] = (0, firestore_1.onSnapshot)((0, firestore_1.query)(collectionRef, ...wheres), (snapshot) => {
            onRecieve(snapshot.docs.map(d => d.data()));
        }, (error) => onError(error));
    }
    unsubscribeListener(name) {
        if (this.listeners[name]) {
            this.listeners[name]();
            delete this.listeners[name];
        }
    }
    hasListener(name) {
        return this.listeners[name] !== undefined;
    }
    delete(blueprint, id) {
        return new Promise(async (resolve, reject) => {
            try {
                if (this.batch) {
                    await this.batch.delete((0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), id));
                    resolve();
                }
                else if (this.transaction) {
                    await this.transaction.delete((0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), id));
                }
                else {
                    await (0, firestore_1.deleteDoc)((0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), id).withConverter(this.getConverter(blueprint.constructorFunction)));
                }
                resolve();
            }
            catch (e) {
                reject(e);
            }
        });
    }
    deleteMany(blueprint, ids) {
        return (new Promise((resolve, reject) => {
            try {
                const promises = ids.map(id => this.delete(blueprint, id));
                Promise.all(promises).then(() => resolve());
            }
            catch (e) {
                reject(e);
            }
        }));
    }
    convertToTimestamp(date) {
        return firestore_1.Timestamp.fromDate(date);
    }
    convertFromTimestamp(timestamp) {
        if (typeof timestamp.toDate === 'function') {
            return timestamp.toDate();
        }
        else {
            return new Date(timestamp.seconds * 1000);
        }
    }
    getConverter(constructor) {
        return {
            toFirestore(item) {
                return item.toJson();
            },
            fromFirestore(snapshot) {
                const data = snapshot.data();
                data.id = snapshot.id;
                return (new constructor()).fromJson(data);
            }
        };
    }
    async runTransaction(operations) {
        return (0, firestore_1.runTransaction)(this.db, async (transaction) => {
            this.transaction = transaction;
            // this.transaction.
            return await operations();
        }).then((result) => {
            this.transaction = null;
            return result;
        }).catch(e => {
            this.transaction = null;
            throw e;
        });
    }
    //TODO over 500 operations per transaction check
    async runBatch(operations) {
        this.batch = (0, firestore_1.writeBatch)(this.db);
        const result = await operations();
        return await this.batch.commit().then(() => {
            this.batch = null;
            return result;
        }).catch(e => {
            this.batch = null;
            throw e;
        });
    }
}
exports.default = ClientEngine;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2xpZW50RW5naW5lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2VuZ2luZS9DbGllbnRFbmdpbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFFQSxtREFBb1Q7QUFNcFQsTUFBcUIsWUFBWTtJQVUvQixZQUFZLEdBQWdCO1FBUDVCLGdCQUFXLEdBQWdCLElBQUksQ0FBQTtRQUMvQixVQUFLLEdBQWUsSUFBSSxDQUFBO1FBRXhCLGNBQVMsR0FBbUMsRUFBRSxDQUFBO1FBRTlDLGtCQUFhLEdBQVksS0FBSyxDQUFBO1FBRzVCLElBQUksQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFBO1FBQ2QsSUFBSSxDQUFDLEVBQUUsR0FBRyxJQUFBLHdCQUFZLEVBQUMsR0FBRyxDQUFDLENBQUE7SUFDN0IsQ0FBQztJQUVELElBQUksQ0FBa0IsS0FBUTtRQUM1QixNQUFNLFNBQVMsR0FBRyxLQUFLLENBQUMsWUFBWSxFQUFFLENBQUE7UUFDdEMsT0FBTyxDQUFDLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQ3RDLElBQUk7Z0JBQ0YsaUdBQWlHO2dCQUNqRyxJQUFJLEtBQUssQ0FBQyxFQUFFLEVBQUU7b0JBQ1osSUFBRyxJQUFJLENBQUMsV0FBVyxFQUFDO3dCQUNsQixJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFBLGVBQUcsRUFBQyxJQUFJLENBQUMsRUFBRSxFQUFFLFNBQVMsQ0FBQyxvQkFBb0IsRUFBRSxFQUFFLEtBQUssQ0FBQyxFQUFFLENBQUMsRUFBRSxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQTt3QkFDOUYsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFBO3FCQUNmO3lCQUFNLElBQUcsSUFBSSxDQUFDLEtBQUssRUFBQzt3QkFDbkIsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBQSxlQUFHLEVBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxTQUFT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SSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUE7WUFFakIsTUFBTSxDQUFDLENBQUE7UUFDVCxDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUM7Q0FHRjtBQWhURCwrQkFnVEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgTW9kZWwgZnJvbSAnfi9tb2RlbHMvTW9kZWwnO1xyXG5pbXBvcnQgeyBGaXJlYmFzZUFwcCwgZ2V0QXBwIH0gZnJvbSBcIkBmaXJlYmFzZS9hcHBcIlxyXG5pbXBvcnQgeyBhZGREb2MsIGNvbGxlY3Rpb24sIGNvbGxlY3Rpb25Hcm91cCwgZGVsZXRlRG9jLCBkb2MsIERvY3VtZW50RGF0YSwgRG9jdW1lbnRTbmFwc2hvdCwgRmlyZXN0b3JlLCBnZXREb2MsIGdldERvY3MsIGdldEZpcmVzdG9yZSwgb25TbmFwc2hvdCwgcXVlcnksIFF1ZXJ5RG9jdW1lbnRTbmFwc2hvdCwgcnVuVHJhbnNhY3Rpb24sIHNldERvYywgVGltZXN0YW1wLCBUcmFuc2FjdGlvbiwgVW5zdWJzY3JpYmUsIHVwZGF0ZURvYywgd2hlcmUsIHdyaXRlQmF0Y2gsIFdyaXRlQmF0Y2ggfSBmcm9tIFwiQGZpcmViYXNlL2ZpcmVzdG9yZVwiXHJcbmltcG9ydCBFbmdpbmVJbnRlcmZhY2UgZnJvbSBcIn4vZW5naW5lL0VuZ2luZUludGVyZmFjZVwiO1xyXG5pbXBvcnQgeyBRdWVyeVBhcmFtIH0gZnJvbSAnfi90eXBlcy9xdWVyaWVzL1F1ZXJ5UGFyYW0nO1xyXG5pbXBvcnQgeyBCbHVlcHJpbnQgfSBmcm9tICd+L21vZGVscy9CbHVlcHJpbnQnO1xyXG5pbXBvcnQgeyBDb25zdHJ1Y3RvckZ1bmN0aW9uIH0gZnJvbSAnfi90eXBlcy9mdW5jdGlvbnMvQ29uc3RydWN0b3JGdW5jdGlvbic7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDbGllbnRFbmdpbmUgaW1wbGVtZW50cyBFbmdpbmVJbnRlcmZhY2Uge1xyXG4gIGFwcDogRmlyZWJhc2VBcHBcclxuICBkYjogRmlyZXN0b3JlXHJcbiAgdHJhbnNhY3Rpb246IFRyYW5zYWN0aW9uID0gbnVsbFxyXG4gIGJhdGNoOiBXcml0ZUJhdGNoID0gbnVsbFxyXG5cclxuICBsaXN0ZW5lcnM6IHsgW2tleTogc3RyaW5nXTogVW5zdWJzY3JpYmUgfSA9IHt9XHJcblxyXG4gIGluVHJhbnNhY3Rpb246IGJvb2xlYW4gPSBmYWxzZVxyXG5cclxuICBjb25zdHJ1Y3RvcihhcHA6IEZpcmViYXNlQXBwKSB7XHJcbiAgICB0aGlzLmFwcCA9IGFwcFxyXG4gICAgdGhpcy5kYiA9IGdldEZpcmVzdG9yZShhcHApXHJcbiAgfVxyXG5cclxuICBzYXZlPFQgZXh0ZW5kcyBNb2RlbD4obW9kZWw6IFQpOiBQcm9taXNlPFQ+IHtcclxuICAgIGNvbnN0IGJsdWVwcmludCA9IG1vZGVsLmdldEJsdWVwcmludCgpXHJcbiAgICByZXR1cm4gKG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgdHJ5IHtcclxuICAgICAgICAvLyBpZiBtb2RlbCBoYXMgaWQsIHRoZW4gdXBkYXRlIGZpcmVzdG9yZSBkb2N1bWVudCBvdGhlcndpc2UgYWRkIGZpcmVzdG9yZSBkb2N1bWVudCB0byBjb2xsZWN0aW9uXHJcbiAgICAgICAgaWYgKG1vZGVsLmlkKSB7XHJcbiAgICAgICAgICBpZih0aGlzLnRyYW5zYWN0aW9uKXtcclxuICAgICAgICAgICAgdGhpcy50cmFuc2FjdGlvbi5zZXQoZG9jKHRoaXMuZGIsIGJsdWVwcmludC5idWlsZENvbGxlY3Rpb25Sb3V0ZSgpLCBtb2RlbC5pZCksIG1vZGVsLnRvSnNvbigpKVxyXG4gICAgICAgICAgICByZXNvbHZlKG1vZGVsKVxyXG4gICAgICAgICAgfSBlbHNlIGlmKHRoaXMuYmF0Y2gpe1xyXG4gICAgICAgICAgICB0aGlzLmJhdGNoLnNldChkb2ModGhpcy5kYiwgYmx1ZXByaW50LmJ1aWxkQ29sbGVjdGlvblJvdXRlKCksIG1vZGVsLmlkKSwgbW9kZWwudG9Kc29uKCkpXHJcbiAgICAgICAgICAgIHJlc29sdmUobW9kZWwpXHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG5cclxuICAgICAgICAgICAgc2V0RG9jKFxyXG4gICAgICAgICAgICAgICAgZG9jKHRoaXMuZGIsIGJsdWVwcmludC5idWlsZENvbGxlY3Rpb25Sb3V0ZSgpLCBtb2RlbC5pZClcclxuICAgICAgICAgICAgICAgIC53aXRoQ29udmVydGVyKHRoaXMuZ2V0Q29udmVydGVyPFQ+KGJsdWVwcmludC5jb25zdHJ1Y3RvckZ1bmN0aW9uKSksIFxyXG4gICAgICAgICAgICAgICAgbW9kZWwpXHJcbiAgICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmVzb2x2ZShtb2RlbClcclxuICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBpZih0aGlzLnRyYW5zYWN0aW9uKXtcclxuICAgICAgICAgICAgY29uc3QgZG9jUmVmID0gZG9jKHRoaXMuZGIsIGJsdWVwcmludC5idWlsZENvbGxlY3Rpb25Sb3V0ZSgpKVxyXG4gICAgICAgICAgICBtb2RlbC5pZCA9IGRvY1JlZi5pZFxyXG4gICAgICAgICAgICB0aGlzLnRyYW5zYWN0aW9uLnNldChkb2NSZWYsIG1vZGVsLnRvSnNvbigpKVxyXG4gICAgICAgICAgICByZXNvbHZlKG1vZGVsKVxyXG4gICAgICAgICAgfSBlbHNlIGlmKHRoaXMuYmF0Y2gpe1xyXG4gICAgICAgICAgICBjb25zdCBkb2NSZWYgPSBkb2ModGhpcy5kYiwgYmx1ZXByaW50LmJ1aWxkQ29sbGVjdGlvblJvdXRlKCkpXHJcbiAgICAgICAgICAgIG1vZGVsLmlkID0gZG9jUmVmLmlkXHJcbiAgICAgICAgICAgIHRoaXMuYmF0Y2guc2V0KGRvY1JlZiwgbW9kZWwudG9Kc29uKCkpXHJcbiAgICAgICAgICAgIHJlc29sdmUobW9kZWwpXHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBsZXQgZG9jUmVmID0gZG9jKGNvbGxlY3Rpb24odGhpcy5kYiwgYmx1ZXByaW50LmJ1aWxkQ29sbGVjdGlvblJvdXRlKCkpKVxyXG4gICAgICAgICAgICAgIC53aXRoQ29udmVydGVyKHRoaXMuZ2V0Q29udmVydGVyPFQ+KGJsdWVwcmludC5jb25zdHJ1Y3RvckZ1bmN0aW9uKSlcclxuICAgICAgICAgICAgbW9kZWwuaWQgPSBkb2NSZWYuaWRcclxuICAgICAgICAgICAgc2V0RG9jKGRvY1JlZiwgbW9kZWwpLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgICAgIHJlc29sdmUobW9kZWwpXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGNhdGNoKGUpIHtcclxuICAgICAgICByZWplY3QoZSlcclxuICAgICAgfVxyXG4gICAgfSkpXHJcbiAgfVxyXG5cclxuICBzYXZlTWFueTxUIGV4dGVuZHMgTW9kZWw+KG1vZGVsczogVFtdKTogUHJvbWlzZTxUW10+IHtcclxuICAgIHJldHVybiAobmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICB0cnkge1xyXG4gICAgICAgIGNvbnN0IHByb21pc2VzID0gbW9kZWxzLm1hcChtb2RlbCA9PiB0aGlzLnNhdmUobW9kZWwpKVxyXG4gICAgICAgIFByb21pc2UuYWxsKHByb21pc2VzKS50aGVuKHJlc29sdmUpXHJcbiAgICAgIH0gY2F0Y2goZSkge1xyXG4gICAgICAgIHJlamVjdChlKVxyXG4gICAgICB9XHJcbiAgICB9KSlcclxuICB9XHJcblxyXG4gIHVwZGF0ZTxUIGV4dGVuZHMgTW9kZWw+KGJsdWVwcmludDogQmx1ZXByaW50PFQ+LCBpZDogc3RyaW5nLCBkYXRhOiBhbnkpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIHJldHVybiAobmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICB0cnkge1xyXG4gICAgICAgIGlmKHRoaXMudHJhbnNhY3Rpb24pe1xyXG4gICAgICAgICAgdGhpcy50cmFuc2FjdGlvbi51cGRhdGUoZG9jKHRoaXMuZGIsIGJsdWVwcmludC5idWlsZENvbGxlY3Rpb25Sb3V0ZSgpLCBpZCksIGRhdGEpXHJcbiAgICAgICAgICByZXNvbHZlKClcclxuICAgICAgICB9IGVsc2UgaWYodGhpcy5iYXRjaCl7XHJcbiAgICAgICAgICB0aGlzLmJhdGNoLnVwZGF0ZShkb2ModGhpcy5kYiwgYmx1ZXByaW50LmJ1aWxkQ29sbGVjdGlvblJvdXRlKCksIGlkKSwgZGF0YSlcclxuICAgICAgICAgIHJlc29sdmUoKVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICB1cGRhdGVEb2MoXHJcbiAgICAgICAgICAgIGRvYyh0aGlzLmRiLCBibHVlcHJpbnQuYnVpbGRDb2xsZWN0aW9uUm91dGUoKSwgaWQpXHJcbiAgICAgICAgICAgIC53aXRoQ29udmVydGVyKHRoaXMuZ2V0Q29udmVydGVyPFQ+KGJsdWVwcmludC5jb25zdHJ1Y3RvckZ1bmN0aW9uKSksIFxyXG4gICAgICAgICAgICBkYXRhKVxyXG4gICAgICAgICAgLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgICByZXNvbHZlKClcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgfVxyXG4gICAgICB9IGNhdGNoKGUpIHtcclxuICAgICAgICByZWplY3QoZSlcclxuICAgICAgfVxyXG4gICAgfSkpXHJcbiAgfVxyXG5cclxuICBhc3luYyB1cGRhdGVNYW55PFQgZXh0ZW5kcyBNb2RlbD4oYmx1ZXByaW50OiBCbHVlcHJpbnQ8VD4sIGlkczogc3RyaW5nW10sIGRhdGE6IGFueSk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgcmV0dXJuIChuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgY29uc3QgcHJvbWlzZXMgPSBpZHMubWFwKGlkID0+IHRoaXMudXBkYXRlKGJsdWVwcmludCwgaWQsIGRhdGEpKVxyXG4gICAgICAgIFByb21pc2UuYWxsKHByb21pc2VzKS50aGVuKCgpID0+IHJlc29sdmUoKSlcclxuICAgICAgfSBjYXRjaChlKSB7XHJcbiAgICAgICAgcmVqZWN0KGUpXHJcbiAgICAgIH1cclxuICAgIH0pKVxyXG4gIH1cclxuXHJcblxyXG4gIGFzeW5jIGxvYWQ8VCBleHRlbmRzIE1vZGVsPihibHVlcHJpbnQ6IEJsdWVwcmludDxUPiwgaWQ6IHN0cmluZyk6IFByb21pc2U8VD4ge1xyXG4gICAgaWYodGhpcy5iYXRjaCl7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGxvYWQgaW4gYmF0Y2gnKVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHF1ZXJ5ID0gZG9jKHRoaXMuZGIsIGJsdWVwcmludC5idWlsZENvbGxlY3Rpb25Sb3V0ZSgpLCBpZCkud2l0aENvbnZlcnRlcih0aGlzLmdldENvbnZlcnRlcjxUPihibHVlcHJpbnQuY29uc3RydWN0b3JGdW5jdGlvbikpXHJcblxyXG4gICAgaWYodGhpcy50cmFuc2FjdGlvbil7XHJcbiAgICAgIHJldHVybiAoYXdhaXQgdGhpcy50cmFuc2FjdGlvbi5nZXQocXVlcnkpKS5kYXRhKCkgYXMgVFxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIChhd2FpdCBnZXREb2MocXVlcnkpKS5kYXRhKCkgYXMgVFxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgYXN5bmMgbG9hZE1hbnk8VCBleHRlbmRzIE1vZGVsPihibHVlcHJpbnQ6IEJsdWVwcmludDxUPiwgaWRzOiBzdHJpbmdbXSk6IFByb21pc2U8VFtdPiB7XHJcbiAgICBpZih0aGlzLmJhdGNoIHx8IHRoaXMudHJhbnNhY3Rpb24pe1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBsb2FkTWFueSBpbiBiYXRjaCcpXHJcbiAgICB9XHJcbiAgICBcclxuICAgIGNvbnN0IGRvY1JlZnMgPSBpZHMubWFwKGlkID0+IGRvYyh0aGlzLmRiLCBibHVlcHJpbnQuYnVpbGRDb2xsZWN0aW9uUm91dGUoKSwgaWQpLndpdGhDb252ZXJ0ZXIodGhpcy5nZXRDb252ZXJ0ZXI8VD4oYmx1ZXByaW50LmNvbnN0cnVjdG9yRnVuY3Rpb24pKSlcclxuXHJcbiAgICBjb25zdCBwcm9taXNlczogUHJvbWlzZTxEb2N1bWVudFNuYXBzaG90PFQ+PltdID0gW11cclxuICAgIGRvY1JlZnMuZm9yRWFjaChkUmVmID0+IHtcclxuICAgICAgaWYodGhpcy50cmFuc2FjdGlvbil7XHJcbiAgICAgICAgICBwcm9taXNlcy5wdXNoKHRoaXMudHJhbnNhY3Rpb24uZ2V0KGRSZWYpKVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcHJvbWlzZXMucHVzaChnZXREb2MoZFJlZikpXHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIChhd2FpdCBQcm9taXNlLmFsbChwcm9taXNlcykpLm1hcChkID0+IGQuZGF0YSgpIGFzIFQpXHJcblxyXG4gICAgXHJcbiAgfVxyXG5cclxuICBhc3luYyBsb2FkQ29sbGVjdGlvbjxUIGV4dGVuZHMgTW9kZWw+KGJsdWVwcmludDogQmx1ZXByaW50PFQ+KTogUHJvbWlzZTxUW10+IHtcclxuICAgIGlmKHRoaXMuYmF0Y2gpe1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBsb2FkQ29sbGVjdGlvbiBpbiBiYXRjaCBvciB0cmFuc2FjdGlvbicpXHJcbiAgICB9XHJcbiAgICBcclxuICAgIGNvbnN0IHF1ZXJ5ID0gY29sbGVjdGlvbih0aGlzLmRiLCBibHVlcHJpbnQuYnVpbGRDb2xsZWN0aW9uUm91dGUoKSkud2l0aENvbnZlcnRlcih0aGlzLmdldENvbnZlcnRlcjxUPihibHVlcHJpbnQuY29uc3RydWN0b3JGdW5jdGlvbikpXHJcbiAgICBcclxuICAgIHJldHVybiAoYXdhaXQgZ2V0RG9jcyhxdWVyeSkpLmRvY3MubWFwKGQgPT4gZC5kYXRhKCkgYXMgVClcclxuICB9XHJcblxyXG4gIC8vVE9ETyBvdGhlciBwYXJhbXRlcnMsIGxpa2UgbGltaXQsIHN0YXJ0QXQsIGV0Yy4uLlxyXG4gIGFzeW5jIHF1ZXJ5PFQgZXh0ZW5kcyBNb2RlbD4oYmx1ZXByaW50OiBCbHVlcHJpbnQ8VD4sIHF1ZXJ5UGFyYW1zOiBRdWVyeVBhcmFtW10pOiBQcm9taXNlPFRbXT4ge1xyXG4gICAgICBpZih0aGlzLmJhdGNoKXtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBxdWVyeSBpbiBiYXRjaCBvciB0cmFuc2FjdGlvbicpXHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnN0IGNvbGxlY3Rpb25SZWYgPSBjb2xsZWN0aW9uKHRoaXMuZGIsIGJsdWVwcmludC5idWlsZENvbGxlY3Rpb25Sb3V0ZSgpKS53aXRoQ29udmVydGVyKHRoaXMuZ2V0Q29udmVydGVyPFQ+KGJsdWVwcmludC5jb25zdHJ1Y3RvckZ1bmN0aW9uKSlcclxuICAgICAgY29uc3Qgd2hlcmVzOiBhbnlbXSA9IFtdXHJcbiAgICAgIHF1ZXJ5UGFyYW1zLmZvckVhY2gocGFyYW0gPT4ge1xyXG4gICAgICAgIHdoZXJlcy5wdXNoKHdoZXJlKHBhcmFtLmZpZWxkLCBwYXJhbS5vcCwgcGFyYW0udmFsdWUpKVxyXG4gICAgICB9KVxyXG4gIFxyXG4gICAgICByZXR1cm4gKGF3YWl0IGdldERvY3MocXVlcnkoY29sbGVjdGlvblJlZiwgLi4ud2hlcmVzKSkpLmRvY3MubWFwKGQgPT4gZC5kYXRhKCkgYXMgVClcclxuICAgICAgIFxyXG4gIH1cclxuXHJcbiAgYXN5bmMgcXVlcnlBc0dyb3VwPFQgZXh0ZW5kcyBNb2RlbD4oYmx1ZXByaW50OiBCbHVlcHJpbnQ8VD4sIHF1ZXJ5UGFyYW1zOiBRdWVyeVBhcmFtW10pOiBQcm9taXNlPFRbXT4ge1xyXG4gICAgaWYodGhpcy5iYXRjaCl7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHF1ZXJ5QXNHcm91cCBpbiBiYXRjaCBvciB0cmFuc2FjdGlvbicpXHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgY29sbGVjdGlvblJlZiA9IGNvbGxlY3Rpb25Hcm91cCh0aGlzLmRiLCBibHVlcHJpbnQuZ2V0U3ViQ29sbGVjdGlvbk5hbWUoKSkud2l0aENvbnZlcnRlcih0aGlzLmdldENvbnZlcnRlcjxUPihibHVlcHJpbnQuY29uc3RydWN0b3JGdW5jdGlvbikpXHJcblxyXG4gICAgY29uc3Qgd2hlcmVzOiBhbnlbXSA9IFtdXHJcbiAgICBxdWVyeVBhcmFtcy5mb3JFYWNoKHBhcmFtID0+IHtcclxuICAgICAgd2hlcmVzLnB1c2god2hlcmUocGFyYW0uZmllbGQsIHBhcmFtLm9wLCBwYXJhbS52YWx1ZSkpXHJcbiAgICB9KVxyXG5cclxuICAgIHJldHVybiAoYXdhaXQgZ2V0RG9jcyhxdWVyeShjb2xsZWN0aW9uUmVmLCAuLi53aGVyZXMpKSkuZG9jcy5tYXAoZCA9PiBkLmRhdGEoKSBhcyBUKVxyXG4gIH1cclxuXHJcbiAgc25hcHNob3RMaXN0ZW5lcjxUIGV4dGVuZHMgTW9kZWw+KG5hbWU6IHN0cmluZywgYmx1ZXByaW50OiBCbHVlcHJpbnQ8VD4sIGlkOiBzdHJpbmcsIG9uUmVjaWV2ZTogKChlbnRpdHk6IFQpID0+IHZvaWQpLCBvbkVycm9yOiAoKGVycm9yOiBFcnJvcikgPT4gdm9pZCkpOiB2b2lkIHtcclxuICAgIHRoaXMubGlzdGVuZXJzW25hbWVdID0gb25TbmFwc2hvdChkb2ModGhpcy5kYiwgYmx1ZXByaW50LmJ1aWxkQ29sbGVjdGlvblJvdXRlKCksIGlkKS53aXRoQ29udmVydGVyKHRoaXMuZ2V0Q29udmVydGVyPFQ+KGJsdWVwcmludC5jb25zdHJ1Y3RvckZ1bmN0aW9uKSksIChzbmFwc2hvdCkgPT4ge1xyXG4gICAgICBvblJlY2lldmUoc25hcHNob3QuZGF0YSgpIGFzIFQpXHJcbiAgICB9LCAoZXJyb3IpID0+IG9uRXJyb3IoZXJyb3IpKVxyXG4gIH1cclxuICBcclxuXHJcbiAgc25hcHNob3RMaXN0ZW5lck1hbnk8VCBleHRlbmRzIE1vZGVsPihuYW1lOiBzdHJpbmcsIGJsdWVwcmludDogQmx1ZXByaW50PFQ+LCBxdWVyeVBhcmFtczogUXVlcnlQYXJhbVtdLCBvblJlY2lldmU6ICgoZW50aXRpZXM6IFRbXSkgPT4gdm9pZCksIG9uRXJyb3I6ICgoZXJyb3I6IEVycm9yKSA9PiB2b2lkKSk6IHZvaWQge1xyXG4gICAgY29uc3QgY29sbGVjdGlvblJlZiA9IGNvbGxlY3Rpb24odGhpcy5kYiwgYmx1ZXByaW50LmJ1aWxkQ29sbGVjdGlvblJvdXRlKCkpLndpdGhDb252ZXJ0ZXIodGhpcy5nZXRDb252ZXJ0ZXI8VD4oYmx1ZXByaW50LmNvbnN0cnVjdG9yRnVuY3Rpb24pKVxyXG4gICAgY29uc3Qgd2hlcmVzOiBhbnlbXSA9IFtdXHJcbiAgICBxdWVyeVBhcmFtcy5mb3JFYWNoKHBhcmFtID0+IHtcclxuICAgICAgd2hlcmVzLnB1c2god2hlcmUocGFyYW0uZmllbGQsIHBhcmFtLm9wLCBwYXJhbS52YWx1ZSkpXHJcbiAgICB9KVxyXG5cclxuICAgIHRoaXMubGlzdGVuZXJzW25hbWVdID0gb25TbmFwc2hvdChxdWVyeShjb2xsZWN0aW9uUmVmLCAuLi53aGVyZXMpLCAoc25hcHNob3QpID0+IHtcclxuICAgICAgb25SZWNpZXZlKHNuYXBzaG90LmRvY3MubWFwKGQgPT4gZC5kYXRhKCkgYXMgVCkpXHJcbiAgICB9LCAoZXJyb3IpID0+IG9uRXJyb3IoZXJyb3IpKVxyXG4gIH1cclxuXHJcbiAgdW5zdWJzY3JpYmVMaXN0ZW5lcihuYW1lOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIGlmKHRoaXMubGlzdGVuZXJzW25hbWVdKXtcclxuICAgICAgdGhpcy5saXN0ZW5lcnNbbmFtZV0oKVxyXG4gICAgICBkZWxldGUgdGhpcy5saXN0ZW5lcnNbbmFtZV1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIGhhc0xpc3RlbmVyKG5hbWU6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIHRoaXMubGlzdGVuZXJzW25hbWVdICE9PSB1bmRlZmluZWRcclxuICB9XHJcblxyXG4gIGRlbGV0ZTxUIGV4dGVuZHMgTW9kZWw+KGJsdWVwcmludDogQmx1ZXByaW50PFQ+LCBpZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoYXN5bmMgKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICB0cnkge1xyXG4gICAgICAgIGlmKHRoaXMuYmF0Y2gpe1xyXG4gICAgICAgICAgYXdhaXQgdGhpcy5iYXRjaC5kZWxldGUoZG9jKHRoaXMuZGIsIGJsdWVwcmludC5idWlsZENvbGxlY3Rpb25Sb3V0ZSgpLCBpZCkpXHJcbiAgICAgICAgICByZXNvbHZlKClcclxuICAgICAgICB9IGVsc2UgaWYodGhpcy50cmFuc2FjdGlvbikge1xyXG4gICAgICAgICAgYXdhaXQgdGhpcy50cmFuc2FjdGlvbi5kZWxldGUoZG9jKHRoaXMuZGIsIGJsdWVwcmludC5idWlsZENvbGxlY3Rpb25Sb3V0ZSgpLCBpZCkpXHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGF3YWl0IGRlbGV0ZURvYyhkb2ModGhpcy5kYiwgYmx1ZXByaW50LmJ1aWxkQ29sbGVjdGlvblJvdXRlKCksIGlkKS53aXRoQ29udmVydGVyKHRoaXMuZ2V0Q29udmVydGVyPFQ+KGJsdWVwcmludC5jb25zdHJ1Y3RvckZ1bmN0aW9uKSkpXHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJlc29sdmUoKVxyXG4gICAgICB9IGNhdGNoKGUpIHtcclxuICAgICAgICByZWplY3QoZSlcclxuICAgICAgfVxyXG4gICAgfSlcclxuICB9XHJcblxyXG4gIGRlbGV0ZU1hbnk8VCBleHRlbmRzIE1vZGVsPihibHVlcHJpbnQ6IEJsdWVwcmludDxUPiwgaWRzOiBzdHJpbmdbXSk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgcmV0dXJuIChuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgY29uc3QgcHJvbWlzZXMgPSBpZHMubWFwKGlkID0+IHRoaXMuZGVsZXRlKGJsdWVwcmludCwgaWQpKVxyXG4gICAgICAgIFByb21pc2UuYWxsKHByb21pc2VzKS50aGVuKCgpID0+IHJlc29sdmUoKSlcclxuICAgICAgfSBjYXRjaChlKSB7XHJcbiAgICAgICAgcmVqZWN0KGUpXHJcbiAgICAgIH1cclxuICAgIH0pKVxyXG4gIH1cclxuXHJcbiAgY29udmVydFRvVGltZXN0YW1wKGRhdGU6IERhdGUpOiBUaW1lc3RhbXB7XHJcbiAgICByZXR1cm4gVGltZXN0YW1wLmZyb21EYXRlKGRhdGUpXHJcbiAgfVxyXG5cclxuICBjb252ZXJ0RnJvbVRpbWVzdGFtcCh0aW1lc3RhbXA6IFRpbWVzdGFtcCl7XHJcbiAgICBpZih0eXBlb2YgdGltZXN0YW1wLnRvRGF0ZSA9PT0gJ2Z1bmN0aW9uJyl7XHJcbiAgICAgIHJldHVybiB0aW1lc3RhbXAudG9EYXRlKClcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiBuZXcgRGF0ZSh0aW1lc3RhbXAuc2Vjb25kcyAqIDEwMDApXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuXHJcbiAgZ2V0Q29udmVydGVyPFQgZXh0ZW5kcyBNb2RlbD4oY29uc3RydWN0b3I6IENvbnN0cnVjdG9yRnVuY3Rpb248VD4pIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIHRvRmlyZXN0b3JlIChpdGVtOiBUKTogRG9jdW1lbnREYXRhIHtcclxuICAgICAgICByZXR1cm4gaXRlbS50b0pzb24oKVxyXG4gICAgICB9LFxyXG4gICAgICBmcm9tRmlyZXN0b3JlIChcclxuICAgICAgICBzbmFwc2hvdDogUXVlcnlEb2N1bWVudFNuYXBzaG90PFQ+LFxyXG4gICAgICApOiBUIHtcclxuICAgICAgICBjb25zdCBkYXRhID0gc25hcHNob3QuZGF0YSgpXHJcbiAgICAgICAgZGF0YS5pZCA9IHNuYXBzaG90LmlkXHJcbiAgICAgICAgcmV0dXJuIChuZXcgY29uc3RydWN0b3IoKSkuZnJvbUpzb24oZGF0YSlcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgYXN5bmMgcnVuVHJhbnNhY3Rpb24ob3BlcmF0aW9uczogKCgpID0+IFByb21pc2U8dm9pZD4pKTogUHJvbWlzZTxhbnk+IHtcclxuICAgIHJldHVybiBydW5UcmFuc2FjdGlvbih0aGlzLmRiLCBhc3luYyB0cmFuc2FjdGlvbiA9PiB7XHJcbiAgICAgIHRoaXMudHJhbnNhY3Rpb24gPSB0cmFuc2FjdGlvblxyXG4gICAgICAvLyB0aGlzLnRyYW5zYWN0aW9uLlxyXG4gICAgICByZXR1cm4gYXdhaXQgb3BlcmF0aW9ucygpXHJcbiAgICB9KS50aGVuKChyZXN1bHQpID0+IHtcclxuICAgICAgdGhpcy50cmFuc2FjdGlvbiA9IG51bGxcclxuICAgICAgcmV0dXJuIHJlc3VsdFxyXG4gICAgfSkuY2F0Y2goZSA9PiB7XHJcbiAgICAgIHRoaXMudHJhbnNhY3Rpb24gPSBudWxsXHJcbiAgICAgIHRocm93IGVcclxuICAgIH0pXHJcbiAgfVxyXG5cclxuICAvL1RPRE8gb3ZlciA1MDAgb3BlcmF0aW9ucyBwZXIgdHJhbnNhY3Rpb24gY2hlY2tcclxuICBhc3luYyBydW5CYXRjaChvcGVyYXRpb25zOiAoKCkgPT4gUHJvbWlzZTx2b2lkPikpOiBQcm9taXNlPGFueT4ge1xyXG4gICAgdGhpcy5iYXRjaCA9IHdyaXRlQmF0Y2godGhpcy5kYilcclxuXHJcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBvcGVyYXRpb25zKClcclxuXHJcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5iYXRjaC5jb21taXQoKS50aGVuKCgpID0+IHtcclxuICAgICAgdGhpcy5iYXRjaCA9IG51bGxcclxuXHJcbiAgICAgIHJldHVybiByZXN1bHRcclxuICAgIH0pLmNhdGNoKGUgPT4ge1xyXG4gICAgICB0aGlzLmJhdGNoID0gbnVsbFxyXG5cclxuICAgICAgdGhyb3cgZVxyXG4gICAgfSlcclxuICB9XHJcblxyXG4gIC8vVE9ETyBkZWxldGUgb3BlcmF0aW9uXHJcbn0iXX0=