"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const firestore_1 = require("@firebase/firestore");
class ClientEngine {
    constructor(app) {
        this.transaction = null;
        this.batch = null;
        this.listeners = {};
        this.inTransaction = false;
        this.app = app;
        this.db = (0, firestore_1.getFirestore)(app);
    }
    save(model) {
        const blueprint = model.getBlueprint();
        return (new Promise((resolve, reject) => {
            try {
                // if model has id, then update firestore document otherwise add firestore document to collection
                if (model.id) {
                    if (this.transaction) {
                        this.transaction.set((0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), model.id), model.toJson());
                        resolve(model);
                    }
                    else if (this.batch) {
                        this.batch.set((0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), model.id), model.toJson());
                        resolve(model);
                    }
                    else {
                        (0, firestore_1.setDoc)((0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), model.id)
                            .withConverter(this.getConverter(blueprint.constructorFunction)), model)
                            .then(() => {
                            resolve(model);
                        });
                    }
                }
                else {
                    if (this.transaction) {
                        const docRef = (0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute());
                        this.transaction.set(docRef, model.toJson());
                        model.id = docRef.id;
                        resolve(model);
                    }
                    else if (this.batch) {
                        const docRef = (0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute());
                        this.batch.set(docRef, model.toJson());
                        model.id = docRef.id;
                        resolve(model);
                    }
                    else {
                        (0, firestore_1.addDoc)((0, firestore_1.collection)(this.db, blueprint.buildCollectionRoute())
                            .withConverter(this.getConverter(blueprint.constructorFunction)), model).then(response => {
                            model.id = response.id;
                            resolve(model);
                        });
                    }
                }
            }
            catch (e) {
                reject(e);
            }
        }));
    }
    saveMany(models) {
        return (new Promise((resolve, reject) => {
            try {
                const promises = models.map(model => this.save(model));
                Promise.all(promises).then(resolve);
            }
            catch (e) {
                reject(e);
            }
        }));
    }
    update(blueprint, id, data) {
        return (new Promise((resolve, reject) => {
            try {
                if (this.transaction) {
                    this.transaction.update((0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), id), data);
                    resolve();
                }
                else if (this.batch) {
                    this.batch.update((0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), id), data);
                    resolve();
                }
                else {
                    (0, firestore_1.updateDoc)((0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), id)
                        .withConverter(this.getConverter(blueprint.constructorFunction)), data)
                        .then(() => {
                        resolve();
                    });
                }
            }
            catch (e) {
                reject(e);
            }
        }));
    }
    async updateMany(blueprint, ids, data) {
        return (new Promise((resolve, reject) => {
            try {
                const promises = ids.map(id => this.update(blueprint, id, data));
                Promise.all(promises).then(() => resolve());
            }
            catch (e) {
                reject(e);
            }
        }));
    }
    async load(blueprint, id) {
        if (this.batch) {
            throw new Error('Cannot load in batch');
        }
        const query = (0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), id).withConverter(this.getConverter(blueprint.constructorFunction));
        if (this.transaction) {
            return (await this.transaction.get(query)).data();
        }
        else {
            return (await (0, firestore_1.getDoc)(query)).data();
        }
    }
    async loadMany(blueprint, ids) {
        if (this.batch || this.transaction) {
            throw new Error('Cannot loadMany in batch');
        }
        const docRefs = ids.map(id => (0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), id).withConverter(this.getConverter(blueprint.constructorFunction)));
        const promises = [];
        docRefs.forEach(dRef => {
            if (this.transaction) {
                promises.push(this.transaction.get(dRef));
            }
            else {
                promises.push((0, firestore_1.getDoc)(dRef));
            }
        });
        return (await Promise.all(promises)).map(d => d.data());
    }
    async loadCollection(blueprint) {
        if (this.batch) {
            throw new Error('Cannot loadCollection in batch or transaction');
        }
        const query = (0, firestore_1.collection)(this.db, blueprint.buildCollectionRoute()).withConverter(this.getConverter(blueprint.constructorFunction));
        return (await (0, firestore_1.getDocs)(query)).docs.map(d => d.data());
    }
    //TODO other paramters, like limit, startAt, etc...
    async query(blueprint, queryParams) {
        if (this.batch) {
            throw new Error('Cannot query in batch or transaction');
        }
        const collectionRef = (0, firestore_1.collection)(this.db, blueprint.buildCollectionRoute()).withConverter(this.getConverter(blueprint.constructorFunction));
        const wheres = [];
        queryParams.forEach(param => {
            wheres.push((0, firestore_1.where)(param.field, param.op, param.value));
        });
        return (await (0, firestore_1.getDocs)((0, firestore_1.query)(collectionRef, ...wheres))).docs.map(d => d.data());
    }
    async queryAsGroup(blueprint, queryParams) {
        if (this.batch) {
            throw new Error('Cannot queryAsGroup in batch or transaction');
        }
        const collectionRef = (0, firestore_1.collectionGroup)(this.db, blueprint.buildCollectionRoute()).withConverter(this.getConverter(blueprint.constructorFunction));
        const wheres = [];
        queryParams.forEach(param => {
            wheres.push((0, firestore_1.where)(param.field, param.op, param.value));
        });
        return (await (0, firestore_1.getDocs)((0, firestore_1.query)(collectionRef, ...wheres))).docs.map(d => d.data());
    }
    snapshotListener(name, blueprint, id, onRecieve) {
        this.listeners[name] = (0, firestore_1.onSnapshot)((0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), id).withConverter(this.getConverter(blueprint.constructorFunction)), (snapshot) => {
            onRecieve(snapshot.data());
        });
    }
    snapshotListenerMany(name, blueprint, queryParams, onRecieve) {
        const collectionRef = (0, firestore_1.collection)(this.db, blueprint.buildCollectionRoute()).withConverter(this.getConverter(blueprint.constructorFunction));
        const wheres = [];
        queryParams.forEach(param => {
            wheres.push((0, firestore_1.where)(param.field, param.op, param.value));
        });
        this.listeners[name] = (0, firestore_1.onSnapshot)((0, firestore_1.query)(collectionRef, ...wheres), (snapshot) => {
            onRecieve(snapshot.docs.map(d => d.data()));
        });
    }
    unsubscribeListener(name) {
        if (this.listeners[name]) {
            this.listeners[name]();
            delete this.listeners[name];
        }
    }
    hasListener(name) {
        return this.listeners[name] !== undefined;
    }
    delete(blueprint, id) {
        return new Promise(async (resolve, reject) => {
            try {
                if (this.batch) {
                    await this.batch.delete((0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), id));
                    resolve();
                }
                else if (this.transaction) {
                    await this.transaction.delete((0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), id));
                }
                else {
                    await (0, firestore_1.deleteDoc)((0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), id).withConverter(this.getConverter(blueprint.constructorFunction)));
                }
                resolve();
            }
            catch (e) {
                reject(e);
            }
        });
    }
    deleteMany(blueprint, ids) {
        return (new Promise((resolve, reject) => {
            try {
                const promises = ids.map(id => this.delete(blueprint, id));
                Promise.all(promises).then(() => resolve());
            }
            catch (e) {
                reject(e);
            }
        }));
    }
    convertToTimestamp(date) {
        return new firestore_1.Timestamp(date.valueOf() / 1000, 0);
    }
    convertFromTimestamp(timestamp) {
        return timestamp.toDate();
    }
    getConverter(constructor) {
        return {
            toFirestore(item) {
                return item.toJson();
            },
            fromFirestore(snapshot) {
                const data = snapshot.data();
                data.id = snapshot.id;
                return (new constructor()).fromJson(data);
            }
        };
    }
    async runTransaction(operations) {
        return (0, firestore_1.runTransaction)(this.db, async (transaction) => {
            this.transaction = transaction;
            // this.transaction.
            return await operations();
        }).then((result) => {
            this.transaction = null;
            return result;
        }).catch(e => {
            this.transaction = null;
            throw e;
        });
    }
    //TODO over 500 operations per transaction check
    async runBatch(operations) {
        this.batch = (0, firestore_1.writeBatch)(this.db);
        const result = await operations();
        return await this.batch.commit().then(() => {
            this.batch = null;
            return result;
        }).catch(e => {
            this.batch = null;
            throw e;
        });
    }
}
exports.default = ClientEngine;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2xpZW50RW5naW5lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2VuZ2luZS9DbGllbnRFbmdpbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFFQSxtREFBb1Q7QUFNcFQsTUFBcUIsWUFBWTtJQVUvQixZQUFZLEdBQWdCO1FBUDVCLGdCQUFXLEdBQWdCLElBQUksQ0FBQTtRQUMvQixVQUFLLEdBQWUsSUFBSSxDQUFBO1FBRXhCLGNBQVMsR0FBbUMsRUFBRSxDQUFBO1FBRTlDLGtCQUFhLEdBQVksS0FBSyxDQUFBO1FBRzVCLElBQUksQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFBO1FBQ2QsSUFBSSxDQUFDLEVBQUUsR0FBRyxJQUFBLHdCQUFZLEVBQUMsR0FBRyxDQUFDLENBQUE7SUFDN0IsQ0FBQztJQUVELElBQUksQ0FBa0IsS0FBUTtRQUM1QixNQUFNLFNBQVMsR0FBRyxLQUFLLENBQUMsWUFBWSxFQUFFLENBQUE7UUFDdEMsT0FBTyxDQUFDLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQ3RDLElBQUk7Z0JBQ0YsaUdBQWlHO2dCQUNqRyxJQUFJLEtBQUssQ0FBQyxFQUFFLEVBQUU7b0JBQ1osSUFBRyxJQUFJLENBQUMsV0FBVyxFQUFDO3dCQUNsQixJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFBLGVBQUcsRUFBQyxJQUFJLENBQUMsRUFBRSxFQUFFLFNBQVMsQ0FBQyxvQkFBb0IsRUFBRSxFQUFFLEtBQUssQ0FBQyxFQUFFLENBQUMsRUFBRSxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQTt3QkFDOUYsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFBO3FCQUNmO3lCQUFNLElBQUcsSUFBSSxDQUFDLEtBQUssRUFBQzt3QkFDbkIsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBQSxlQUFHLEVBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxTQUFT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QyxXQUFXLEdBQUcsV0FBVyxDQUFBO1lBQzlCLG9CQUFvQjtZQUNwQixPQUFPLE1BQU0sVUFBVSxFQUFFLENBQUE7UUFDM0IsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUU7WUFDakIsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUE7WUFDdkIsT0FBTyxNQUFNLENBQUE7UUFDZixDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDWCxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQTtZQUN2QixNQUFNLENBQUMsQ0FBQTtRQUNULENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQztJQUVELGdEQUFnRDtJQUNoRCxLQUFLLENBQUMsUUFBUSxDQUFDLFVBQWlDO1FBQzlDLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBQSxzQkFBVSxFQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQTtRQUVoQyxNQUFNLE1BQU0sR0FBRyxNQUFNLFVBQVUsRUFBRSxDQUFBO1FBRWpDLE9BQU8sTUFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUU7WUFDekMsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUE7WUFFakIsT0FBTyxNQUFNLENBQUE7UUFDZixDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDWCxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQTtZQUVqQixNQUFNLENBQUMsQ0FBQTtRQUNULENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQztDQUdGO0FBNVNELCtCQTRTQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBNb2RlbCBmcm9tICd+L21vZGVscy9Nb2RlbCc7XHJcbmltcG9ydCB7IEZpcmViYXNlQXBwLCBnZXRBcHAgfSBmcm9tIFwiQGZpcmViYXNlL2FwcFwiXHJcbmltcG9ydCB7IGFkZERvYywgY29sbGVjdGlvbiwgY29sbGVjdGlvbkdyb3VwLCBkZWxldGVEb2MsIGRvYywgRG9jdW1lbnREYXRhLCBEb2N1bWVudFNuYXBzaG90LCBGaXJlc3RvcmUsIGdldERvYywgZ2V0RG9jcywgZ2V0RmlyZXN0b3JlLCBvblNuYXBzaG90LCBxdWVyeSwgUXVlcnlEb2N1bWVudFNuYXBzaG90LCBydW5UcmFuc2FjdGlvbiwgc2V0RG9jLCBUaW1lc3RhbXAsIFRyYW5zYWN0aW9uLCBVbnN1YnNjcmliZSwgdXBkYXRlRG9jLCB3aGVyZSwgd3JpdGVCYXRjaCwgV3JpdGVCYXRjaCB9IGZyb20gXCJAZmlyZWJhc2UvZmlyZXN0b3JlXCJcclxuaW1wb3J0IEVuZ2luZUludGVyZmFjZSBmcm9tIFwifi9lbmdpbmUvRW5naW5lSW50ZXJmYWNlXCI7XHJcbmltcG9ydCB7IFF1ZXJ5UGFyYW0gfSBmcm9tICd+L3R5cGVzL3F1ZXJpZXMvUXVlcnlQYXJhbSc7XHJcbmltcG9ydCB7IEJsdWVwcmludCB9IGZyb20gJ34vbW9kZWxzL0JsdWVwcmludCc7XHJcbmltcG9ydCB7IENvbnN0cnVjdG9yRnVuY3Rpb24gfSBmcm9tICd+L3R5cGVzL2Z1bmN0aW9ucy9Db25zdHJ1Y3RvckZ1bmN0aW9uJztcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIENsaWVudEVuZ2luZSBpbXBsZW1lbnRzIEVuZ2luZUludGVyZmFjZSB7XHJcbiAgYXBwOiBGaXJlYmFzZUFwcFxyXG4gIGRiOiBGaXJlc3RvcmVcclxuICB0cmFuc2FjdGlvbjogVHJhbnNhY3Rpb24gPSBudWxsXHJcbiAgYmF0Y2g6IFdyaXRlQmF0Y2ggPSBudWxsXHJcblxyXG4gIGxpc3RlbmVyczogeyBba2V5OiBzdHJpbmddOiBVbnN1YnNjcmliZSB9ID0ge31cclxuXHJcbiAgaW5UcmFuc2FjdGlvbjogYm9vbGVhbiA9IGZhbHNlXHJcblxyXG4gIGNvbnN0cnVjdG9yKGFwcDogRmlyZWJhc2VBcHApIHtcclxuICAgIHRoaXMuYXBwID0gYXBwXHJcbiAgICB0aGlzLmRiID0gZ2V0RmlyZXN0b3JlKGFwcClcclxuICB9XHJcblxyXG4gIHNhdmU8VCBleHRlbmRzIE1vZGVsPihtb2RlbDogVCk6IFByb21pc2U8VD4ge1xyXG4gICAgY29uc3QgYmx1ZXByaW50ID0gbW9kZWwuZ2V0Qmx1ZXByaW50KClcclxuICAgIHJldHVybiAobmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICB0cnkge1xyXG4gICAgICAgIC8vIGlmIG1vZGVsIGhhcyBpZCwgdGhlbiB1cGRhdGUgZmlyZXN0b3JlIGRvY3VtZW50IG90aGVyd2lzZSBhZGQgZmlyZXN0b3JlIGRvY3VtZW50IHRvIGNvbGxlY3Rpb25cclxuICAgICAgICBpZiAobW9kZWwuaWQpIHtcclxuICAgICAgICAgIGlmKHRoaXMudHJhbnNhY3Rpb24pe1xyXG4gICAgICAgICAgICB0aGlzLnRyYW5zYWN0aW9uLnNldChkb2ModGhpcy5kYiwgYmx1ZXByaW50LmJ1aWxkQ29sbGVjdGlvblJvdXRlKCksIG1vZGVsLmlkKSwgbW9kZWwudG9Kc29uKCkpXHJcbiAgICAgICAgICAgIHJlc29sdmUobW9kZWwpXHJcbiAgICAgICAgICB9IGVsc2UgaWYodGhpcy5iYXRjaCl7XHJcbiAgICAgICAgICAgIHRoaXMuYmF0Y2guc2V0KGRvYyh0aGlzLmRiLCBibHVlcHJpbnQuYnVpbGRDb2xsZWN0aW9uUm91dGUoKSwgbW9kZWwuaWQpLCBtb2RlbC50b0pzb24oKSlcclxuICAgICAgICAgICAgcmVzb2x2ZShtb2RlbClcclxuICAgICAgICAgIH0gZWxzZSB7XHJcblxyXG4gICAgICAgICAgICBzZXREb2MoXHJcbiAgICAgICAgICAgICAgICBkb2ModGhpcy5kYiwgYmx1ZXByaW50LmJ1aWxkQ29sbGVjdGlvblJvdXRlKCksIG1vZGVsLmlkKVxyXG4gICAgICAgICAgICAgICAgLndpdGhDb252ZXJ0ZXIodGhpcy5nZXRDb252ZXJ0ZXI8VD4oYmx1ZXByaW50LmNvbnN0cnVjdG9yRnVuY3Rpb24pKSwgXHJcbiAgICAgICAgICAgICAgICBtb2RlbClcclxuICAgICAgICAgICAgICAudGhlbigoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXNvbHZlKG1vZGVsKVxyXG4gICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGlmKHRoaXMudHJhbnNhY3Rpb24pe1xyXG4gICAgICAgICAgICBjb25zdCBkb2NSZWYgPSBkb2ModGhpcy5kYiwgYmx1ZXByaW50LmJ1aWxkQ29sbGVjdGlvblJvdXRlKCkpXHJcbiAgICAgICAgICAgIHRoaXMudHJhbnNhY3Rpb24uc2V0KGRvY1JlZiwgbW9kZWwudG9Kc29uKCkpXHJcbiAgICAgICAgICAgIG1vZGVsLmlkID0gZG9jUmVmLmlkXHJcbiAgICAgICAgICAgIHJlc29sdmUobW9kZWwpXHJcbiAgICAgICAgICB9IGVsc2UgaWYodGhpcy5iYXRjaCl7XHJcbiAgICAgICAgICAgIGNvbnN0IGRvY1JlZiA9IGRvYyh0aGlzLmRiLCBibHVlcHJpbnQuYnVpbGRDb2xsZWN0aW9uUm91dGUoKSlcclxuICAgICAgICAgICAgdGhpcy5iYXRjaC5zZXQoZG9jUmVmLCBtb2RlbC50b0pzb24oKSlcclxuICAgICAgICAgICAgbW9kZWwuaWQgPSBkb2NSZWYuaWRcclxuICAgICAgICAgICAgcmVzb2x2ZShtb2RlbClcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGFkZERvYyhjb2xsZWN0aW9uKHRoaXMuZGIsIGJsdWVwcmludC5idWlsZENvbGxlY3Rpb25Sb3V0ZSgpKVxyXG4gICAgICAgICAgICAgIC53aXRoQ29udmVydGVyKHRoaXMuZ2V0Q29udmVydGVyPFQ+KGJsdWVwcmludC5jb25zdHJ1Y3RvckZ1bmN0aW9uKSksIFxyXG4gICAgICAgICAgICBtb2RlbCkudGhlbihyZXNwb25zZSA9PiB7XHJcbiAgICAgICAgICAgICAgbW9kZWwuaWQgPSByZXNwb25zZS5pZFxyXG4gICAgICAgICAgICAgIHJlc29sdmUobW9kZWwpXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGNhdGNoKGUpIHtcclxuICAgICAgICByZWplY3QoZSlcclxuICAgICAgfVxyXG4gICAgfSkpXHJcbiAgfVxyXG5cclxuICBzYXZlTWFueTxUIGV4dGVuZHMgTW9kZWw+KG1vZGVsczogVFtdKTogUHJvbWlzZTxUW10+IHtcclxuICAgIHJldHVybiAobmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICB0cnkge1xyXG4gICAgICAgIGNvbnN0IHByb21pc2VzID0gbW9kZWxzLm1hcChtb2RlbCA9PiB0aGlzLnNhdmUobW9kZWwpKVxyXG4gICAgICAgIFByb21pc2UuYWxsKHByb21pc2VzKS50aGVuKHJlc29sdmUpXHJcbiAgICAgIH0gY2F0Y2goZSkge1xyXG4gICAgICAgIHJlamVjdChlKVxyXG4gICAgICB9XHJcbiAgICB9KSlcclxuICB9XHJcblxyXG4gIHVwZGF0ZTxUIGV4dGVuZHMgTW9kZWw+KGJsdWVwcmludDogQmx1ZXByaW50PFQ+LCBpZDogc3RyaW5nLCBkYXRhOiBhbnkpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIHJldHVybiAobmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICB0cnkge1xyXG4gICAgICAgIGlmKHRoaXMudHJhbnNhY3Rpb24pe1xyXG4gICAgICAgICAgdGhpcy50cmFuc2FjdGlvbi51cGRhdGUoZG9jKHRoaXMuZGIsIGJsdWVwcmludC5idWlsZENvbGxlY3Rpb25Sb3V0ZSgpLCBpZCksIGRhdGEpXHJcbiAgICAgICAgICByZXNvbHZlKClcclxuICAgICAgICB9IGVsc2UgaWYodGhpcy5iYXRjaCl7XHJcbiAgICAgICAgICB0aGlzLmJhdGNoLnVwZGF0ZShkb2ModGhpcy5kYiwgYmx1ZXByaW50LmJ1aWxkQ29sbGVjdGlvblJvdXRlKCksIGlkKSwgZGF0YSlcclxuICAgICAgICAgIHJlc29sdmUoKVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICB1cGRhdGVEb2MoXHJcbiAgICAgICAgICAgIGRvYyh0aGlzLmRiLCBibHVlcHJpbnQuYnVpbGRDb2xsZWN0aW9uUm91dGUoKSwgaWQpXHJcbiAgICAgICAgICAgIC53aXRoQ29udmVydGVyKHRoaXMuZ2V0Q29udmVydGVyPFQ+KGJsdWVwcmludC5jb25zdHJ1Y3RvckZ1bmN0aW9uKSksIFxyXG4gICAgICAgICAgICBkYXRhKVxyXG4gICAgICAgICAgLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgICByZXNvbHZlKClcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgfVxyXG4gICAgICB9IGNhdGNoKGUpIHtcclxuICAgICAgICByZWplY3QoZSlcclxuICAgICAgfVxyXG4gICAgfSkpXHJcbiAgfVxyXG5cclxuICBhc3luYyB1cGRhdGVNYW55PFQgZXh0ZW5kcyBNb2RlbD4oYmx1ZXByaW50OiBCbHVlcHJpbnQ8VD4sIGlkczogc3RyaW5nW10sIGRhdGE6IGFueSk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgcmV0dXJuIChuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgY29uc3QgcHJvbWlzZXMgPSBpZHMubWFwKGlkID0+IHRoaXMudXBkYXRlKGJsdWVwcmludCwgaWQsIGRhdGEpKVxyXG4gICAgICAgIFByb21pc2UuYWxsKHByb21pc2VzKS50aGVuKCgpID0+IHJlc29sdmUoKSlcclxuICAgICAgfSBjYXRjaChlKSB7XHJcbiAgICAgICAgcmVqZWN0KGUpXHJcbiAgICAgIH1cclxuICAgIH0pKVxyXG4gIH1cclxuXHJcblxyXG4gIGFzeW5jIGxvYWQ8VCBleHRlbmRzIE1vZGVsPihibHVlcHJpbnQ6IEJsdWVwcmludDxUPiwgaWQ6IHN0cmluZyk6IFByb21pc2U8VD4ge1xyXG4gICAgaWYodGhpcy5iYXRjaCl7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGxvYWQgaW4gYmF0Y2gnKVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHF1ZXJ5ID0gZG9jKHRoaXMuZGIsIGJsdWVwcmludC5idWlsZENvbGxlY3Rpb25Sb3V0ZSgpLCBpZCkud2l0aENvbnZlcnRlcih0aGlzLmdldENvbnZlcnRlcjxUPihibHVlcHJpbnQuY29uc3RydWN0b3JGdW5jdGlvbikpXHJcblxyXG4gICAgaWYodGhpcy50cmFuc2FjdGlvbil7XHJcbiAgICAgIHJldHVybiAoYXdhaXQgdGhpcy50cmFuc2FjdGlvbi5nZXQocXVlcnkpKS5kYXRhKCkgYXMgVFxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIChhd2FpdCBnZXREb2MocXVlcnkpKS5kYXRhKCkgYXMgVFxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgYXN5bmMgbG9hZE1hbnk8VCBleHRlbmRzIE1vZGVsPihibHVlcHJpbnQ6IEJsdWVwcmludDxUPiwgaWRzOiBzdHJpbmdbXSk6IFByb21pc2U8VFtdPiB7XHJcbiAgICBpZih0aGlzLmJhdGNoIHx8IHRoaXMudHJhbnNhY3Rpb24pe1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBsb2FkTWFueSBpbiBiYXRjaCcpXHJcbiAgICB9XHJcbiAgICBcclxuICAgIGNvbnN0IGRvY1JlZnMgPSBpZHMubWFwKGlkID0+IGRvYyh0aGlzLmRiLCBibHVlcHJpbnQuYnVpbGRDb2xsZWN0aW9uUm91dGUoKSwgaWQpLndpdGhDb252ZXJ0ZXIodGhpcy5nZXRDb252ZXJ0ZXI8VD4oYmx1ZXByaW50LmNvbnN0cnVjdG9yRnVuY3Rpb24pKSlcclxuXHJcbiAgICBjb25zdCBwcm9taXNlczogUHJvbWlzZTxEb2N1bWVudFNuYXBzaG90PFQ+PltdID0gW11cclxuICAgIGRvY1JlZnMuZm9yRWFjaChkUmVmID0+IHtcclxuICAgICAgaWYodGhpcy50cmFuc2FjdGlvbil7XHJcbiAgICAgICAgICBwcm9taXNlcy5wdXNoKHRoaXMudHJhbnNhY3Rpb24uZ2V0KGRSZWYpKVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcHJvbWlzZXMucHVzaChnZXREb2MoZFJlZikpXHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIChhd2FpdCBQcm9taXNlLmFsbChwcm9taXNlcykpLm1hcChkID0+IGQuZGF0YSgpIGFzIFQpXHJcblxyXG4gICAgXHJcbiAgfVxyXG5cclxuICBhc3luYyBsb2FkQ29sbGVjdGlvbjxUIGV4dGVuZHMgTW9kZWw+KGJsdWVwcmludDogQmx1ZXByaW50PFQ+KTogUHJvbWlzZTxUW10+IHtcclxuICAgIGlmKHRoaXMuYmF0Y2gpe1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBsb2FkQ29sbGVjdGlvbiBpbiBiYXRjaCBvciB0cmFuc2FjdGlvbicpXHJcbiAgICB9XHJcbiAgICBcclxuICAgIGNvbnN0IHF1ZXJ5ID0gY29sbGVjdGlvbih0aGlzLmRiLCBibHVlcHJpbnQuYnVpbGRDb2xsZWN0aW9uUm91dGUoKSkud2l0aENvbnZlcnRlcih0aGlzLmdldENvbnZlcnRlcjxUPihibHVlcHJpbnQuY29uc3RydWN0b3JGdW5jdGlvbikpXHJcbiAgICBcclxuICAgIHJldHVybiAoYXdhaXQgZ2V0RG9jcyhxdWVyeSkpLmRvY3MubWFwKGQgPT4gZC5kYXRhKCkgYXMgVClcclxuICB9XHJcblxyXG4gIC8vVE9ETyBvdGhlciBwYXJhbXRlcnMsIGxpa2UgbGltaXQsIHN0YXJ0QXQsIGV0Yy4uLlxyXG4gIGFzeW5jIHF1ZXJ5PFQgZXh0ZW5kcyBNb2RlbD4oYmx1ZXByaW50OiBCbHVlcHJpbnQ8VD4sIHF1ZXJ5UGFyYW1zOiBRdWVyeVBhcmFtW10pOiBQcm9taXNlPFRbXT4ge1xyXG4gICAgICBpZih0aGlzLmJhdGNoKXtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBxdWVyeSBpbiBiYXRjaCBvciB0cmFuc2FjdGlvbicpXHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnN0IGNvbGxlY3Rpb25SZWYgPSBjb2xsZWN0aW9uKHRoaXMuZGIsIGJsdWVwcmludC5idWlsZENvbGxlY3Rpb25Sb3V0ZSgpKS53aXRoQ29udmVydGVyKHRoaXMuZ2V0Q29udmVydGVyPFQ+KGJsdWVwcmludC5jb25zdHJ1Y3RvckZ1bmN0aW9uKSlcclxuICAgICAgY29uc3Qgd2hlcmVzOiBhbnlbXSA9IFtdXHJcbiAgICAgIHF1ZXJ5UGFyYW1zLmZvckVhY2gocGFyYW0gPT4ge1xyXG4gICAgICAgIHdoZXJlcy5wdXNoKHdoZXJlKHBhcmFtLmZpZWxkLCBwYXJhbS5vcCwgcGFyYW0udmFsdWUpKVxyXG4gICAgICB9KVxyXG4gIFxyXG4gICAgICByZXR1cm4gKGF3YWl0IGdldERvY3MocXVlcnkoY29sbGVjdGlvblJlZiwgLi4ud2hlcmVzKSkpLmRvY3MubWFwKGQgPT4gZC5kYXRhKCkgYXMgVClcclxuICAgICAgIFxyXG4gIH1cclxuXHJcbiAgYXN5bmMgcXVlcnlBc0dyb3VwPFQgZXh0ZW5kcyBNb2RlbD4oYmx1ZXByaW50OiBCbHVlcHJpbnQ8VD4sIHF1ZXJ5UGFyYW1zOiBRdWVyeVBhcmFtW10pOiBQcm9taXNlPFRbXT4ge1xyXG4gICAgaWYodGhpcy5iYXRjaCl7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHF1ZXJ5QXNHcm91cCBpbiBiYXRjaCBvciB0cmFuc2FjdGlvbicpXHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgY29sbGVjdGlvblJlZiA9IGNvbGxlY3Rpb25Hcm91cCh0aGlzLmRiLCBibHVlcHJpbnQuYnVpbGRDb2xsZWN0aW9uUm91dGUoKSkud2l0aENvbnZlcnRlcih0aGlzLmdldENvbnZlcnRlcjxUPihibHVlcHJpbnQuY29uc3RydWN0b3JGdW5jdGlvbikpXHJcblxyXG4gICAgY29uc3Qgd2hlcmVzOiBhbnlbXSA9IFtdXHJcbiAgICBxdWVyeVBhcmFtcy5mb3JFYWNoKHBhcmFtID0+IHtcclxuICAgICAgd2hlcmVzLnB1c2god2hlcmUocGFyYW0uZmllbGQsIHBhcmFtLm9wLCBwYXJhbS52YWx1ZSkpXHJcbiAgICB9KVxyXG5cclxuICAgIHJldHVybiAoYXdhaXQgZ2V0RG9jcyhxdWVyeShjb2xsZWN0aW9uUmVmLCAuLi53aGVyZXMpKSkuZG9jcy5tYXAoZCA9PiBkLmRhdGEoKSBhcyBUKVxyXG4gIH1cclxuXHJcbiAgc25hcHNob3RMaXN0ZW5lcjxUIGV4dGVuZHMgTW9kZWw+KG5hbWU6IHN0cmluZywgYmx1ZXByaW50OiBCbHVlcHJpbnQ8VD4sIGlkOiBzdHJpbmcsIG9uUmVjaWV2ZTogKChlbnRpdHk6IFQpID0+IHZvaWQpKTogdm9pZCB7XHJcbiAgICB0aGlzLmxpc3RlbmVyc1tuYW1lXSA9IG9uU25hcHNob3QoZG9jKHRoaXMuZGIsIGJsdWVwcmludC5idWlsZENvbGxlY3Rpb25Sb3V0ZSgpLCBpZCkud2l0aENvbnZlcnRlcih0aGlzLmdldENvbnZlcnRlcjxUPihibHVlcHJpbnQuY29uc3RydWN0b3JGdW5jdGlvbikpLCAoc25hcHNob3QpID0+IHtcclxuICAgICAgb25SZWNpZXZlKHNuYXBzaG90LmRhdGEoKSBhcyBUKVxyXG4gICAgfSlcclxuICB9XHJcbiAgXHJcblxyXG4gIHNuYXBzaG90TGlzdGVuZXJNYW55PFQgZXh0ZW5kcyBNb2RlbD4obmFtZTogc3RyaW5nLCBibHVlcHJpbnQ6IEJsdWVwcmludDxUPiwgcXVlcnlQYXJhbXM6IFF1ZXJ5UGFyYW1bXSwgb25SZWNpZXZlOiAoKGVudGl0aWVzOiBUW10pID0+IHZvaWQpKTogdm9pZCB7XHJcbiAgICBjb25zdCBjb2xsZWN0aW9uUmVmID0gY29sbGVjdGlvbih0aGlzLmRiLCBibHVlcHJpbnQuYnVpbGRDb2xsZWN0aW9uUm91dGUoKSkud2l0aENvbnZlcnRlcih0aGlzLmdldENvbnZlcnRlcjxUPihibHVlcHJpbnQuY29uc3RydWN0b3JGdW5jdGlvbikpXHJcbiAgICBjb25zdCB3aGVyZXM6IGFueVtdID0gW11cclxuICAgIHF1ZXJ5UGFyYW1zLmZvckVhY2gocGFyYW0gPT4ge1xyXG4gICAgICB3aGVyZXMucHVzaCh3aGVyZShwYXJhbS5maWVsZCwgcGFyYW0ub3AsIHBhcmFtLnZhbHVlKSlcclxuICAgIH0pXHJcblxyXG4gICAgdGhpcy5saXN0ZW5lcnNbbmFtZV0gPSBvblNuYXBzaG90KHF1ZXJ5KGNvbGxlY3Rpb25SZWYsIC4uLndoZXJlcyksIChzbmFwc2hvdCkgPT4ge1xyXG4gICAgICBvblJlY2lldmUoc25hcHNob3QuZG9jcy5tYXAoZCA9PiBkLmRhdGEoKSBhcyBUKSlcclxuICAgIH0pXHJcbiAgfVxyXG5cclxuICB1bnN1YnNjcmliZUxpc3RlbmVyKG5hbWU6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgaWYodGhpcy5saXN0ZW5lcnNbbmFtZV0pe1xyXG4gICAgICB0aGlzLmxpc3RlbmVyc1tuYW1lXSgpXHJcbiAgICAgIGRlbGV0ZSB0aGlzLmxpc3RlbmVyc1tuYW1lXVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgaGFzTGlzdGVuZXIobmFtZTogc3RyaW5nKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gdGhpcy5saXN0ZW5lcnNbbmFtZV0gIT09IHVuZGVmaW5lZFxyXG4gIH1cclxuXHJcbiAgZGVsZXRlPFQgZXh0ZW5kcyBNb2RlbD4oYmx1ZXByaW50OiBCbHVlcHJpbnQ8VD4sIGlkOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZShhc3luYyAocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgaWYodGhpcy5iYXRjaCl7XHJcbiAgICAgICAgICBhd2FpdCB0aGlzLmJhdGNoLmRlbGV0ZShkb2ModGhpcy5kYiwgYmx1ZXByaW50LmJ1aWxkQ29sbGVjdGlvblJvdXRlKCksIGlkKSlcclxuICAgICAgICAgIHJlc29sdmUoKVxyXG4gICAgICAgIH0gZWxzZSBpZih0aGlzLnRyYW5zYWN0aW9uKSB7XHJcbiAgICAgICAgICBhd2FpdCB0aGlzLnRyYW5zYWN0aW9uLmRlbGV0ZShkb2ModGhpcy5kYiwgYmx1ZXByaW50LmJ1aWxkQ29sbGVjdGlvblJvdXRlKCksIGlkKSlcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgYXdhaXQgZGVsZXRlRG9jKGRvYyh0aGlzLmRiLCBibHVlcHJpbnQuYnVpbGRDb2xsZWN0aW9uUm91dGUoKSwgaWQpLndpdGhDb252ZXJ0ZXIodGhpcy5nZXRDb252ZXJ0ZXI8VD4oYmx1ZXByaW50LmNvbnN0cnVjdG9yRnVuY3Rpb24pKSlcclxuICAgICAgICB9XHJcbiAgICAgICAgcmVzb2x2ZSgpXHJcbiAgICAgIH0gY2F0Y2goZSkge1xyXG4gICAgICAgIHJlamVjdChlKVxyXG4gICAgICB9XHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgZGVsZXRlTWFueTxUIGV4dGVuZHMgTW9kZWw+KGJsdWVwcmludDogQmx1ZXByaW50PFQ+LCBpZHM6IHN0cmluZ1tdKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICByZXR1cm4gKG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgdHJ5IHtcclxuICAgICAgICBjb25zdCBwcm9taXNlcyA9IGlkcy5tYXAoaWQgPT4gdGhpcy5kZWxldGUoYmx1ZXByaW50LCBpZCkpXHJcbiAgICAgICAgUHJvbWlzZS5hbGwocHJvbWlzZXMpLnRoZW4oKCkgPT4gcmVzb2x2ZSgpKVxyXG4gICAgICB9IGNhdGNoKGUpIHtcclxuICAgICAgICByZWplY3QoZSlcclxuICAgICAgfVxyXG4gICAgfSkpXHJcbiAgfVxyXG5cclxuICBjb252ZXJ0VG9UaW1lc3RhbXAoZGF0ZTogRGF0ZSk6IFRpbWVzdGFtcHtcclxuICAgIHJldHVybiBuZXcgVGltZXN0YW1wKGRhdGUudmFsdWVPZigpIC8gMTAwMCwgMClcclxuICB9XHJcblxyXG4gIGNvbnZlcnRGcm9tVGltZXN0YW1wKHRpbWVzdGFtcDogVGltZXN0YW1wKXtcclxuICAgIHJldHVybiB0aW1lc3RhbXAudG9EYXRlKClcclxuICB9XHJcblxyXG5cclxuICBnZXRDb252ZXJ0ZXI8VCBleHRlbmRzIE1vZGVsPihjb25zdHJ1Y3RvcjogQ29uc3RydWN0b3JGdW5jdGlvbjxUPikge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgdG9GaXJlc3RvcmUgKGl0ZW06IFQpOiBEb2N1bWVudERhdGEge1xyXG4gICAgICAgIHJldHVybiBpdGVtLnRvSnNvbigpXHJcbiAgICAgIH0sXHJcbiAgICAgIGZyb21GaXJlc3RvcmUgKFxyXG4gICAgICAgIHNuYXBzaG90OiBRdWVyeURvY3VtZW50U25hcHNob3Q8VD4sXHJcbiAgICAgICk6IFQge1xyXG4gICAgICAgIGNvbnN0IGRhdGEgPSBzbmFwc2hvdC5kYXRhKClcclxuICAgICAgICBkYXRhLmlkID0gc25hcHNob3QuaWRcclxuICAgICAgICByZXR1cm4gKG5ldyBjb25zdHJ1Y3RvcigpKS5mcm9tSnNvbihkYXRhKVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBhc3luYyBydW5UcmFuc2FjdGlvbihvcGVyYXRpb25zOiAoKCkgPT4gUHJvbWlzZTx2b2lkPikpOiBQcm9taXNlPGFueT4ge1xyXG4gICAgcmV0dXJuIHJ1blRyYW5zYWN0aW9uKHRoaXMuZGIsIGFzeW5jIHRyYW5zYWN0aW9uID0+IHtcclxuICAgICAgdGhpcy50cmFuc2FjdGlvbiA9IHRyYW5zYWN0aW9uXHJcbiAgICAgIC8vIHRoaXMudHJhbnNhY3Rpb24uXHJcbiAgICAgIHJldHVybiBhd2FpdCBvcGVyYXRpb25zKClcclxuICAgIH0pLnRoZW4oKHJlc3VsdCkgPT4ge1xyXG4gICAgICB0aGlzLnRyYW5zYWN0aW9uID0gbnVsbFxyXG4gICAgICByZXR1cm4gcmVzdWx0XHJcbiAgICB9KS5jYXRjaChlID0+IHtcclxuICAgICAgdGhpcy50cmFuc2FjdGlvbiA9IG51bGxcclxuICAgICAgdGhyb3cgZVxyXG4gICAgfSlcclxuICB9XHJcblxyXG4gIC8vVE9ETyBvdmVyIDUwMCBvcGVyYXRpb25zIHBlciB0cmFuc2FjdGlvbiBjaGVja1xyXG4gIGFzeW5jIHJ1bkJhdGNoKG9wZXJhdGlvbnM6ICgoKSA9PiBQcm9taXNlPHZvaWQ+KSk6IFByb21pc2U8YW55PiB7XHJcbiAgICB0aGlzLmJhdGNoID0gd3JpdGVCYXRjaCh0aGlzLmRiKVxyXG5cclxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IG9wZXJhdGlvbnMoKVxyXG5cclxuICAgIHJldHVybiBhd2FpdCB0aGlzLmJhdGNoLmNvbW1pdCgpLnRoZW4oKCkgPT4ge1xyXG4gICAgICB0aGlzLmJhdGNoID0gbnVsbFxyXG5cclxuICAgICAgcmV0dXJuIHJlc3VsdFxyXG4gICAgfSkuY2F0Y2goZSA9PiB7XHJcbiAgICAgIHRoaXMuYmF0Y2ggPSBudWxsXHJcblxyXG4gICAgICB0aHJvdyBlXHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgLy9UT0RPIGRlbGV0ZSBvcGVyYXRpb25cclxufSJdfQ==