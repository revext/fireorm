"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const firestore_1 = require("@firebase/firestore");
class ClientEngine {
    constructor(app) {
        this.transaction = null;
        this.batch = null;
        this.listeners = {};
        this.inTransaction = false;
        this.app = app;
        this.db = (0, firestore_1.getFirestore)(app);
    }
    save(model) {
        const blueprint = model.getBlueprint();
        return (new Promise((resolve, reject) => {
            try {
                // if model has id, then update firestore document otherwise add firestore document to collection
                if (model.id) {
                    if (this.transaction) {
                        this.transaction.set((0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), model.id), model.toJson(true));
                        resolve(model);
                    }
                    else if (this.batch) {
                        this.batch.set((0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), model.id), model.toJson(true));
                        resolve(model);
                    }
                    else {
                        (0, firestore_1.setDoc)((0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), model.id)
                            .withConverter(this.getConverter(blueprint.constructorFunction)), model)
                            .then(() => {
                            resolve(model);
                        });
                    }
                }
                else {
                    if (this.transaction) {
                        const docRef = (0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute());
                        model.id = docRef.id;
                        this.transaction.set(docRef, model.toJson(true));
                        resolve(model);
                    }
                    else if (this.batch) {
                        const docRef = (0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute());
                        model.id = docRef.id;
                        this.batch.set(docRef, model.toJson(true));
                        resolve(model);
                    }
                    else {
                        let docRef = (0, firestore_1.doc)((0, firestore_1.collection)(this.db, blueprint.buildCollectionRoute()))
                            .withConverter(this.getConverter(blueprint.constructorFunction));
                        model.id = docRef.id;
                        (0, firestore_1.setDoc)(docRef, model).then(() => {
                            resolve(model);
                        });
                    }
                }
            }
            catch (e) {
                reject(e);
            }
        }));
    }
    saveMany(models) {
        return (new Promise((resolve, reject) => {
            try {
                const promises = models.map(model => this.save(model));
                Promise.all(promises).then(resolve).catch(e => reject(e));
            }
            catch (e) {
                reject(e);
            }
        }));
    }
    update(blueprint, id, data) {
        return (new Promise((resolve, reject) => {
            try {
                if (this.transaction) {
                    this.transaction.update((0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), id), data);
                    resolve();
                }
                else if (this.batch) {
                    this.batch.update((0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), id), data);
                    resolve();
                }
                else {
                    (0, firestore_1.updateDoc)((0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), id)
                        .withConverter(this.getConverter(blueprint.constructorFunction)), data)
                        .then(() => {
                        resolve();
                    });
                }
            }
            catch (e) {
                reject(e);
            }
        }));
    }
    async updateMany(blueprint, ids, data) {
        return (new Promise((resolve, reject) => {
            try {
                const promises = ids.map(id => this.update(blueprint, id, data));
                Promise.all(promises).then(() => resolve()).catch(e => reject(e));
            }
            catch (e) {
                reject(e);
            }
        }));
    }
    async load(blueprint, id) {
        if (this.batch) {
            throw new Error('Cannot load in batch');
        }
        const query = (0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), id).withConverter(this.getConverter(blueprint.constructorFunction));
        if (this.transaction) {
            return (await this.transaction.get(query)).data();
        }
        else {
            return (await (0, firestore_1.getDoc)(query)).data();
        }
    }
    async loadMany(blueprint, ids) {
        if (this.batch || this.transaction) {
            throw new Error('Cannot loadMany in batch');
        }
        const docRefs = ids.map(id => (0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), id).withConverter(this.getConverter(blueprint.constructorFunction)));
        const promises = [];
        docRefs.forEach(dRef => {
            if (this.transaction) {
                promises.push(this.transaction.get(dRef));
            }
            else {
                promises.push((0, firestore_1.getDoc)(dRef));
            }
        });
        return (await Promise.all(promises)).map(d => d.data());
    }
    async loadCollection(blueprint) {
        if (this.batch) {
            throw new Error('Cannot loadCollection in batch or transaction');
        }
        const query = (0, firestore_1.collection)(this.db, blueprint.buildCollectionRoute()).withConverter(this.getConverter(blueprint.constructorFunction));
        return (await (0, firestore_1.getDocs)(query)).docs.map(d => d.data());
    }
    //TODO other paramters, like limit, startAt, etc...
    async query(blueprint, queryParams) {
        if (this.batch) {
            throw new Error('Cannot query in batch or transaction');
        }
        const collectionRef = (0, firestore_1.collection)(this.db, blueprint.buildCollectionRoute()).withConverter(this.getConverter(blueprint.constructorFunction));
        const wheres = [];
        queryParams.forEach(param => {
            wheres.push((0, firestore_1.where)(param.field, param.op, param.value));
        });
        return (await (0, firestore_1.getDocs)((0, firestore_1.query)(collectionRef, ...wheres))).docs.map(d => d.data());
    }
    async queryAsGroup(blueprint, queryParams) {
        if (this.batch) {
            throw new Error('Cannot queryAsGroup in batch or transaction');
        }
        const collectionRef = (0, firestore_1.collectionGroup)(this.db, blueprint.getSubCollectionName()).withConverter(this.getConverter(blueprint.constructorFunction));
        const wheres = [];
        queryParams.forEach(param => {
            wheres.push((0, firestore_1.where)(param.field, param.op, param.value));
        });
        return (await (0, firestore_1.getDocs)((0, firestore_1.query)(collectionRef, ...wheres))).docs.map(d => d.data());
    }
    snapshotListener(name, blueprint, id, onRecieve, onError = null) {
        this.listeners[name] = (0, firestore_1.onSnapshot)((0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), id).withConverter(this.getConverter(blueprint.constructorFunction)), (snapshot) => {
            onRecieve(snapshot.data());
        }, (error) => onError(error));
    }
    snapshotListenerMany(name, blueprint, queryParams, onRecieve, onError = null) {
        const collectionRef = (0, firestore_1.collection)(this.db, blueprint.buildCollectionRoute()).withConverter(this.getConverter(blueprint.constructorFunction));
        const wheres = [];
        queryParams.forEach(param => {
            wheres.push((0, firestore_1.where)(param.field, param.op, param.value));
        });
        this.listeners[name] = (0, firestore_1.onSnapshot)((0, firestore_1.query)(collectionRef, ...wheres), (snapshot) => {
            onRecieve(snapshot.docs.map(d => d.data()));
        }, (error) => onError(error));
    }
    unsubscribeListener(name) {
        if (this.listeners[name]) {
            this.listeners[name]();
            delete this.listeners[name];
        }
    }
    hasListener(name) {
        return this.listeners[name] !== undefined;
    }
    delete(blueprint, id) {
        return new Promise(async (resolve, reject) => {
            try {
                if (this.batch) {
                    await this.batch.delete((0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), id));
                    resolve();
                }
                else if (this.transaction) {
                    await this.transaction.delete((0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), id));
                }
                else {
                    await (0, firestore_1.deleteDoc)((0, firestore_1.doc)(this.db, blueprint.buildCollectionRoute(), id).withConverter(this.getConverter(blueprint.constructorFunction)));
                }
                resolve();
            }
            catch (e) {
                reject(e);
            }
        });
    }
    deleteMany(blueprint, ids) {
        return (new Promise((resolve, reject) => {
            try {
                const promises = ids.map(id => this.delete(blueprint, id));
                Promise.all(promises).then(() => resolve()).catch(e => reject(e));
            }
            catch (e) {
                reject(e);
            }
        }));
    }
    convertToTimestamp(date) {
        return firestore_1.Timestamp.fromDate(date);
    }
    convertFromTimestamp(timestamp) {
        if (typeof timestamp.toDate === 'function') {
            return timestamp.toDate();
        }
        else {
            return new Date(timestamp.seconds * 1000);
        }
    }
    getConverter(constructor) {
        return {
            toFirestore(item) {
                return item.toJson(true);
            },
            fromFirestore(snapshot) {
                const data = snapshot.data();
                data.id = snapshot.id;
                return (new constructor()).fromJson(data, true);
            }
        };
    }
    async runTransaction(operations) {
        return new Promise((resolve, reject) => {
            (0, firestore_1.runTransaction)(this.db, async (transaction) => {
                this.transaction = transaction;
                // this.transaction.
                return operations();
            }).then((result) => {
                this.transaction = null;
                resolve(result);
            }).catch(e => {
                this.transaction = null;
                reject(e);
            });
        });
    }
    //TODO over 500 operations per transaction check
    async runBatch(operations) {
        return new Promise((resolve, reject) => {
            this.batch = (0, firestore_1.writeBatch)(this.db);
            operations().then(() => {
                return this.batch.commit();
            }).then((result) => {
                this.batch = null;
                resolve(result);
            }).catch(e => {
                this.batch = null;
                reject(e);
            });
        });
    }
}
exports.default = ClientEngine;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2xpZW50RW5naW5lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2VuZ2luZS9DbGllbnRFbmdpbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFFQSxtREFBb1Q7QUFNcFQsTUFBcUIsWUFBWTtJQVUvQixZQUFZLEdBQWdCO1FBUDVCLGdCQUFXLEdBQWdCLElBQUksQ0FBQTtRQUMvQixVQUFLLEdBQWUsSUFBSSxDQUFBO1FBRXhCLGNBQVMsR0FBbUMsRUFBRSxDQUFBO1FBRTlDLGtCQUFhLEdBQVksS0FBSyxDQUFBO1FBRzVCLElBQUksQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFBO1FBQ2QsSUFBSSxDQUFDLEVBQUUsR0FBRyxJQUFBLHdCQUFZLEVBQUMsR0FBRyxDQUFDLENBQUE7SUFDN0IsQ0FBQztJQUVELElBQUksQ0FBa0IsS0FBUTtRQUM1QixNQUFNLFNBQVMsR0FBRyxLQUFLLENBQUMsWUFBWSxFQUFFLENBQUE7UUFDdEMsT0FBTyxDQUFDLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQ3RDLElBQUk7Z0JBQ0YsaUdBQWlHO2dCQUNqRyxJQUFJLEtBQUssQ0FBQyxFQUFFLEVBQUU7b0JBQ1osSUFBRyxJQUFJLENBQUMsV0FBVyxFQUFDO3dCQUNsQixJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFBLGVBQUcsRUFBQyxJQUFJLENBQUMsRUFBRSxFQUFFLFNBQVMsQ0FBQyxvQkFBb0IsRUFBRSxFQUFFLEtBQUssQ0FBQyxFQUFFLENBQUMsRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUE7d0JBQ2xHLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQTtxQkFDZjt5QkFBTSxJQUFHLElBQUksQ0FBQyxLQUFLLEVBQUM7d0JBQ25CLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUEsZUFBRyxFQUFDLElBQUksQ0FBQyxFQUFF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O0lBQ0osQ0FBQztJQUVELGdEQUFnRDtJQUNoRCxLQUFLLENBQUMsUUFBUSxDQUFDLFVBQWlDO1FBQzlDLE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDckMsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFBLHNCQUFVLEVBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFBO1lBQ2hDLFVBQVUsRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUU7Z0JBQ3JCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQTtZQUM1QixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRTtnQkFDakIsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUE7Z0JBQ2pCLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQTtZQUNqQixDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUU7Z0JBQ1gsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUE7Z0JBQ2pCLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQTtZQUNYLENBQUMsQ0FBQyxDQUFBO1FBQ0osQ0FBQyxDQUFDLENBQUE7SUFDSixDQUFDO0NBR0Y7QUFqVEQsK0JBaVRDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IE1vZGVsIGZyb20gJ34vbW9kZWxzL01vZGVsJztcclxuaW1wb3J0IHsgRmlyZWJhc2VBcHAsIGdldEFwcCB9IGZyb20gXCJAZmlyZWJhc2UvYXBwXCJcclxuaW1wb3J0IHsgYWRkRG9jLCBjb2xsZWN0aW9uLCBjb2xsZWN0aW9uR3JvdXAsIGRlbGV0ZURvYywgZG9jLCBEb2N1bWVudERhdGEsIERvY3VtZW50U25hcHNob3QsIEZpcmVzdG9yZSwgZ2V0RG9jLCBnZXREb2NzLCBnZXRGaXJlc3RvcmUsIG9uU25hcHNob3QsIHF1ZXJ5LCBRdWVyeURvY3VtZW50U25hcHNob3QsIHJ1blRyYW5zYWN0aW9uLCBzZXREb2MsIFRpbWVzdGFtcCwgVHJhbnNhY3Rpb24sIFVuc3Vic2NyaWJlLCB1cGRhdGVEb2MsIHdoZXJlLCB3cml0ZUJhdGNoLCBXcml0ZUJhdGNoIH0gZnJvbSBcIkBmaXJlYmFzZS9maXJlc3RvcmVcIlxyXG5pbXBvcnQgRW5naW5lSW50ZXJmYWNlIGZyb20gXCJ+L2VuZ2luZS9FbmdpbmVJbnRlcmZhY2VcIjtcclxuaW1wb3J0IHsgUXVlcnlQYXJhbSB9IGZyb20gJ34vdHlwZXMvcXVlcmllcy9RdWVyeVBhcmFtJztcclxuaW1wb3J0IHsgQmx1ZXByaW50IH0gZnJvbSAnfi9tb2RlbHMvQmx1ZXByaW50JztcclxuaW1wb3J0IHsgQ29uc3RydWN0b3JGdW5jdGlvbiB9IGZyb20gJ34vdHlwZXMvZnVuY3Rpb25zL0NvbnN0cnVjdG9yRnVuY3Rpb24nO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQ2xpZW50RW5naW5lIGltcGxlbWVudHMgRW5naW5lSW50ZXJmYWNlIHtcclxuICBhcHA6IEZpcmViYXNlQXBwXHJcbiAgZGI6IEZpcmVzdG9yZVxyXG4gIHRyYW5zYWN0aW9uOiBUcmFuc2FjdGlvbiA9IG51bGxcclxuICBiYXRjaDogV3JpdGVCYXRjaCA9IG51bGxcclxuXHJcbiAgbGlzdGVuZXJzOiB7IFtrZXk6IHN0cmluZ106IFVuc3Vic2NyaWJlIH0gPSB7fVxyXG5cclxuICBpblRyYW5zYWN0aW9uOiBib29sZWFuID0gZmFsc2VcclxuXHJcbiAgY29uc3RydWN0b3IoYXBwOiBGaXJlYmFzZUFwcCkge1xyXG4gICAgdGhpcy5hcHAgPSBhcHBcclxuICAgIHRoaXMuZGIgPSBnZXRGaXJlc3RvcmUoYXBwKVxyXG4gIH1cclxuXHJcbiAgc2F2ZTxUIGV4dGVuZHMgTW9kZWw+KG1vZGVsOiBUKTogUHJvbWlzZTxUPiB7XHJcbiAgICBjb25zdCBibHVlcHJpbnQgPSBtb2RlbC5nZXRCbHVlcHJpbnQoKVxyXG4gICAgcmV0dXJuIChuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgLy8gaWYgbW9kZWwgaGFzIGlkLCB0aGVuIHVwZGF0ZSBmaXJlc3RvcmUgZG9jdW1lbnQgb3RoZXJ3aXNlIGFkZCBmaXJlc3RvcmUgZG9jdW1lbnQgdG8gY29sbGVjdGlvblxyXG4gICAgICAgIGlmIChtb2RlbC5pZCkge1xyXG4gICAgICAgICAgaWYodGhpcy50cmFuc2FjdGlvbil7XHJcbiAgICAgICAgICAgIHRoaXMudHJhbnNhY3Rpb24uc2V0KGRvYyh0aGlzLmRiLCBibHVlcHJpbnQuYnVpbGRDb2xsZWN0aW9uUm91dGUoKSwgbW9kZWwuaWQpLCBtb2RlbC50b0pzb24odHJ1ZSkpXHJcbiAgICAgICAgICAgIHJlc29sdmUobW9kZWwpXHJcbiAgICAgICAgICB9IGVsc2UgaWYodGhpcy5iYXRjaCl7XHJcbiAgICAgICAgICAgIHRoaXMuYmF0Y2guc2V0KGRvYyh0aGlzLmRiLCBibHVlcHJpbnQuYnVpbGRDb2xsZWN0aW9uUm91dGUoKSwgbW9kZWwuaWQpLCBtb2RlbC50b0pzb24odHJ1ZSkpXHJcbiAgICAgICAgICAgIHJlc29sdmUobW9kZWwpXHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG5cclxuICAgICAgICAgICAgc2V0RG9jKFxyXG4gICAgICAgICAgICAgICAgZG9jKHRoaXMuZGIsIGJsdWVwcmludC5idWlsZENvbGxlY3Rpb25Sb3V0ZSgpLCBtb2RlbC5pZClcclxuICAgICAgICAgICAgICAgIC53aXRoQ29udmVydGVyKHRoaXMuZ2V0Q29udmVydGVyPFQ+KGJsdWVwcmludC5jb25zdHJ1Y3RvckZ1bmN0aW9uKSksIFxyXG4gICAgICAgICAgICAgICAgbW9kZWwpXHJcbiAgICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmVzb2x2ZShtb2RlbClcclxuICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBpZih0aGlzLnRyYW5zYWN0aW9uKXtcclxuICAgICAgICAgICAgY29uc3QgZG9jUmVmID0gZG9jKHRoaXMuZGIsIGJsdWVwcmludC5idWlsZENvbGxlY3Rpb25Sb3V0ZSgpKVxyXG4gICAgICAgICAgICBtb2RlbC5pZCA9IGRvY1JlZi5pZFxyXG4gICAgICAgICAgICB0aGlzLnRyYW5zYWN0aW9uLnNldChkb2NSZWYsIG1vZGVsLnRvSnNvbih0cnVlKSlcclxuICAgICAgICAgICAgcmVzb2x2ZShtb2RlbClcclxuICAgICAgICAgIH0gZWxzZSBpZih0aGlzLmJhdGNoKXtcclxuICAgICAgICAgICAgY29uc3QgZG9jUmVmID0gZG9jKHRoaXMuZGIsIGJsdWVwcmludC5idWlsZENvbGxlY3Rpb25Sb3V0ZSgpKVxyXG4gICAgICAgICAgICBtb2RlbC5pZCA9IGRvY1JlZi5pZFxyXG4gICAgICAgICAgICB0aGlzLmJhdGNoLnNldChkb2NSZWYsIG1vZGVsLnRvSnNvbih0cnVlKSlcclxuICAgICAgICAgICAgcmVzb2x2ZShtb2RlbClcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGxldCBkb2NSZWYgPSBkb2MoY29sbGVjdGlvbih0aGlzLmRiLCBibHVlcHJpbnQuYnVpbGRDb2xsZWN0aW9uUm91dGUoKSkpXHJcbiAgICAgICAgICAgICAgLndpdGhDb252ZXJ0ZXIodGhpcy5nZXRDb252ZXJ0ZXI8VD4oYmx1ZXByaW50LmNvbnN0cnVjdG9yRnVuY3Rpb24pKVxyXG4gICAgICAgICAgICBtb2RlbC5pZCA9IGRvY1JlZi5pZFxyXG4gICAgICAgICAgICBzZXREb2MoZG9jUmVmLCBtb2RlbCkudGhlbigoKSA9PiB7XHJcbiAgICAgICAgICAgICAgcmVzb2x2ZShtb2RlbClcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH0gY2F0Y2goZSkge1xyXG4gICAgICAgIHJlamVjdChlKVxyXG4gICAgICB9XHJcbiAgICB9KSlcclxuICB9XHJcblxyXG4gIHNhdmVNYW55PFQgZXh0ZW5kcyBNb2RlbD4obW9kZWxzOiBUW10pOiBQcm9taXNlPFRbXT4ge1xyXG4gICAgcmV0dXJuIChuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgY29uc3QgcHJvbWlzZXMgPSBtb2RlbHMubWFwKG1vZGVsID0+IHRoaXMuc2F2ZShtb2RlbCkpXHJcbiAgICAgICAgUHJvbWlzZS5hbGwocHJvbWlzZXMpLnRoZW4ocmVzb2x2ZSkuY2F0Y2goZSA9PiByZWplY3QoZSkpXHJcbiAgICAgIH0gY2F0Y2goZSkge1xyXG4gICAgICAgIHJlamVjdChlKVxyXG4gICAgICB9XHJcbiAgICB9KSlcclxuICB9XHJcblxyXG4gIHVwZGF0ZTxUIGV4dGVuZHMgTW9kZWw+KGJsdWVwcmludDogQmx1ZXByaW50PFQ+LCBpZDogc3RyaW5nLCBkYXRhOiBhbnkpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIHJldHVybiAobmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICB0cnkge1xyXG4gICAgICAgIGlmKHRoaXMudHJhbnNhY3Rpb24pe1xyXG4gICAgICAgICAgdGhpcy50cmFuc2FjdGlvbi51cGRhdGUoZG9jKHRoaXMuZGIsIGJsdWVwcmludC5idWlsZENvbGxlY3Rpb25Sb3V0ZSgpLCBpZCksIGRhdGEpXHJcbiAgICAgICAgICByZXNvbHZlKClcclxuICAgICAgICB9IGVsc2UgaWYodGhpcy5iYXRjaCl7XHJcbiAgICAgICAgICB0aGlzLmJhdGNoLnVwZGF0ZShkb2ModGhpcy5kYiwgYmx1ZXByaW50LmJ1aWxkQ29sbGVjdGlvblJvdXRlKCksIGlkKSwgZGF0YSlcclxuICAgICAgICAgIHJlc29sdmUoKVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICB1cGRhdGVEb2MoXHJcbiAgICAgICAgICAgIGRvYyh0aGlzLmRiLCBibHVlcHJpbnQuYnVpbGRDb2xsZWN0aW9uUm91dGUoKSwgaWQpXHJcbiAgICAgICAgICAgIC53aXRoQ29udmVydGVyKHRoaXMuZ2V0Q29udmVydGVyPFQ+KGJsdWVwcmludC5jb25zdHJ1Y3RvckZ1bmN0aW9uKSksIFxyXG4gICAgICAgICAgICBkYXRhKVxyXG4gICAgICAgICAgLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgICByZXNvbHZlKClcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgfVxyXG4gICAgICB9IGNhdGNoKGUpIHtcclxuICAgICAgICByZWplY3QoZSlcclxuICAgICAgfVxyXG4gICAgfSkpXHJcbiAgfVxyXG5cclxuICBhc3luYyB1cGRhdGVNYW55PFQgZXh0ZW5kcyBNb2RlbD4oYmx1ZXByaW50OiBCbHVlcHJpbnQ8VD4sIGlkczogc3RyaW5nW10sIGRhdGE6IGFueSk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgcmV0dXJuIChuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgY29uc3QgcHJvbWlzZXMgPSBpZHMubWFwKGlkID0+IHRoaXMudXBkYXRlKGJsdWVwcmludCwgaWQsIGRhdGEpKVxyXG4gICAgICAgIFByb21pc2UuYWxsKHByb21pc2VzKS50aGVuKCgpID0+IHJlc29sdmUoKSkuY2F0Y2goZSA9PiByZWplY3QoZSkpXHJcbiAgICAgIH0gY2F0Y2goZSkge1xyXG4gICAgICAgIHJlamVjdChlKVxyXG4gICAgICB9XHJcbiAgICB9KSlcclxuICB9XHJcblxyXG5cclxuICBhc3luYyBsb2FkPFQgZXh0ZW5kcyBNb2RlbD4oYmx1ZXByaW50OiBCbHVlcHJpbnQ8VD4sIGlkOiBzdHJpbmcpOiBQcm9taXNlPFQ+IHtcclxuICAgIGlmKHRoaXMuYmF0Y2gpe1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBsb2FkIGluIGJhdGNoJylcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBxdWVyeSA9IGRvYyh0aGlzLmRiLCBibHVlcHJpbnQuYnVpbGRDb2xsZWN0aW9uUm91dGUoKSwgaWQpLndpdGhDb252ZXJ0ZXIodGhpcy5nZXRDb252ZXJ0ZXI8VD4oYmx1ZXByaW50LmNvbnN0cnVjdG9yRnVuY3Rpb24pKVxyXG5cclxuICAgIGlmKHRoaXMudHJhbnNhY3Rpb24pe1xyXG4gICAgICByZXR1cm4gKGF3YWl0IHRoaXMudHJhbnNhY3Rpb24uZ2V0KHF1ZXJ5KSkuZGF0YSgpIGFzIFRcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiAoYXdhaXQgZ2V0RG9jKHF1ZXJ5KSkuZGF0YSgpIGFzIFRcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFzeW5jIGxvYWRNYW55PFQgZXh0ZW5kcyBNb2RlbD4oYmx1ZXByaW50OiBCbHVlcHJpbnQ8VD4sIGlkczogc3RyaW5nW10pOiBQcm9taXNlPFRbXT4ge1xyXG4gICAgaWYodGhpcy5iYXRjaCB8fCB0aGlzLnRyYW5zYWN0aW9uKXtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgbG9hZE1hbnkgaW4gYmF0Y2gnKVxyXG4gICAgfVxyXG4gICAgXHJcbiAgICBjb25zdCBkb2NSZWZzID0gaWRzLm1hcChpZCA9PiBkb2ModGhpcy5kYiwgYmx1ZXByaW50LmJ1aWxkQ29sbGVjdGlvblJvdXRlKCksIGlkKS53aXRoQ29udmVydGVyKHRoaXMuZ2V0Q29udmVydGVyPFQ+KGJsdWVwcmludC5jb25zdHJ1Y3RvckZ1bmN0aW9uKSkpXHJcblxyXG4gICAgY29uc3QgcHJvbWlzZXM6IFByb21pc2U8RG9jdW1lbnRTbmFwc2hvdDxUPj5bXSA9IFtdXHJcbiAgICBkb2NSZWZzLmZvckVhY2goZFJlZiA9PiB7XHJcbiAgICAgIGlmKHRoaXMudHJhbnNhY3Rpb24pe1xyXG4gICAgICAgICAgcHJvbWlzZXMucHVzaCh0aGlzLnRyYW5zYWN0aW9uLmdldChkUmVmKSlcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHByb21pc2VzLnB1c2goZ2V0RG9jKGRSZWYpKVxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIHJldHVybiAoYXdhaXQgUHJvbWlzZS5hbGwocHJvbWlzZXMpKS5tYXAoZCA9PiBkLmRhdGEoKSBhcyBUKVxyXG5cclxuICAgIFxyXG4gIH1cclxuXHJcbiAgYXN5bmMgbG9hZENvbGxlY3Rpb248VCBleHRlbmRzIE1vZGVsPihibHVlcHJpbnQ6IEJsdWVwcmludDxUPik6IFByb21pc2U8VFtdPiB7XHJcbiAgICBpZih0aGlzLmJhdGNoKXtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgbG9hZENvbGxlY3Rpb24gaW4gYmF0Y2ggb3IgdHJhbnNhY3Rpb24nKVxyXG4gICAgfVxyXG4gICAgXHJcbiAgICBjb25zdCBxdWVyeSA9IGNvbGxlY3Rpb24odGhpcy5kYiwgYmx1ZXByaW50LmJ1aWxkQ29sbGVjdGlvblJvdXRlKCkpLndpdGhDb252ZXJ0ZXIodGhpcy5nZXRDb252ZXJ0ZXI8VD4oYmx1ZXByaW50LmNvbnN0cnVjdG9yRnVuY3Rpb24pKVxyXG4gICAgXHJcbiAgICByZXR1cm4gKGF3YWl0IGdldERvY3MocXVlcnkpKS5kb2NzLm1hcChkID0+IGQuZGF0YSgpIGFzIFQpXHJcbiAgfVxyXG5cclxuICAvL1RPRE8gb3RoZXIgcGFyYW10ZXJzLCBsaWtlIGxpbWl0LCBzdGFydEF0LCBldGMuLi5cclxuICBhc3luYyBxdWVyeTxUIGV4dGVuZHMgTW9kZWw+KGJsdWVwcmludDogQmx1ZXByaW50PFQ+LCBxdWVyeVBhcmFtczogUXVlcnlQYXJhbVtdKTogUHJvbWlzZTxUW10+IHtcclxuICAgICAgaWYodGhpcy5iYXRjaCl7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgcXVlcnkgaW4gYmF0Y2ggb3IgdHJhbnNhY3Rpb24nKVxyXG4gICAgICB9XHJcblxyXG4gICAgICBjb25zdCBjb2xsZWN0aW9uUmVmID0gY29sbGVjdGlvbih0aGlzLmRiLCBibHVlcHJpbnQuYnVpbGRDb2xsZWN0aW9uUm91dGUoKSkud2l0aENvbnZlcnRlcih0aGlzLmdldENvbnZlcnRlcjxUPihibHVlcHJpbnQuY29uc3RydWN0b3JGdW5jdGlvbikpXHJcbiAgICAgIGNvbnN0IHdoZXJlczogYW55W10gPSBbXVxyXG4gICAgICBxdWVyeVBhcmFtcy5mb3JFYWNoKHBhcmFtID0+IHtcclxuICAgICAgICB3aGVyZXMucHVzaCh3aGVyZShwYXJhbS5maWVsZCwgcGFyYW0ub3AsIHBhcmFtLnZhbHVlKSlcclxuICAgICAgfSlcclxuICBcclxuICAgICAgcmV0dXJuIChhd2FpdCBnZXREb2NzKHF1ZXJ5KGNvbGxlY3Rpb25SZWYsIC4uLndoZXJlcykpKS5kb2NzLm1hcChkID0+IGQuZGF0YSgpIGFzIFQpXHJcbiAgICAgICBcclxuICB9XHJcblxyXG4gIGFzeW5jIHF1ZXJ5QXNHcm91cDxUIGV4dGVuZHMgTW9kZWw+KGJsdWVwcmludDogQmx1ZXByaW50PFQ+LCBxdWVyeVBhcmFtczogUXVlcnlQYXJhbVtdKTogUHJvbWlzZTxUW10+IHtcclxuICAgIGlmKHRoaXMuYmF0Y2gpe1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBxdWVyeUFzR3JvdXAgaW4gYmF0Y2ggb3IgdHJhbnNhY3Rpb24nKVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGNvbGxlY3Rpb25SZWYgPSBjb2xsZWN0aW9uR3JvdXAodGhpcy5kYiwgYmx1ZXByaW50LmdldFN1YkNvbGxlY3Rpb25OYW1lKCkpLndpdGhDb252ZXJ0ZXIodGhpcy5nZXRDb252ZXJ0ZXI8VD4oYmx1ZXByaW50LmNvbnN0cnVjdG9yRnVuY3Rpb24pKVxyXG5cclxuICAgIGNvbnN0IHdoZXJlczogYW55W10gPSBbXVxyXG4gICAgcXVlcnlQYXJhbXMuZm9yRWFjaChwYXJhbSA9PiB7XHJcbiAgICAgIHdoZXJlcy5wdXNoKHdoZXJlKHBhcmFtLmZpZWxkLCBwYXJhbS5vcCwgcGFyYW0udmFsdWUpKVxyXG4gICAgfSlcclxuXHJcbiAgICByZXR1cm4gKGF3YWl0IGdldERvY3MocXVlcnkoY29sbGVjdGlvblJlZiwgLi4ud2hlcmVzKSkpLmRvY3MubWFwKGQgPT4gZC5kYXRhKCkgYXMgVClcclxuICB9XHJcblxyXG4gIHNuYXBzaG90TGlzdGVuZXI8VCBleHRlbmRzIE1vZGVsPihuYW1lOiBzdHJpbmcsIGJsdWVwcmludDogQmx1ZXByaW50PFQ+LCBpZDogc3RyaW5nLCBvblJlY2lldmU6ICgoZW50aXR5OiBUKSA9PiB2b2lkKSwgb25FcnJvcjogKChlcnJvcjogRXJyb3IpID0+IHZvaWQpID0gbnVsbCk6IHZvaWQge1xyXG4gICAgdGhpcy5saXN0ZW5lcnNbbmFtZV0gPSBvblNuYXBzaG90KGRvYyh0aGlzLmRiLCBibHVlcHJpbnQuYnVpbGRDb2xsZWN0aW9uUm91dGUoKSwgaWQpLndpdGhDb252ZXJ0ZXIodGhpcy5nZXRDb252ZXJ0ZXI8VD4oYmx1ZXByaW50LmNvbnN0cnVjdG9yRnVuY3Rpb24pKSwgKHNuYXBzaG90KSA9PiB7XHJcbiAgICAgIG9uUmVjaWV2ZShzbmFwc2hvdC5kYXRhKCkgYXMgVClcclxuICAgIH0sIChlcnJvcikgPT4gb25FcnJvcihlcnJvcikpXHJcbiAgfVxyXG4gIFxyXG5cclxuICBzbmFwc2hvdExpc3RlbmVyTWFueTxUIGV4dGVuZHMgTW9kZWw+KG5hbWU6IHN0cmluZywgYmx1ZXByaW50OiBCbHVlcHJpbnQ8VD4sIHF1ZXJ5UGFyYW1zOiBRdWVyeVBhcmFtW10sIG9uUmVjaWV2ZTogKChlbnRpdGllczogVFtdKSA9PiB2b2lkKSwgb25FcnJvcjogKChlcnJvcjogRXJyb3IpID0+IHZvaWQpID0gbnVsbCk6IHZvaWQge1xyXG4gICAgY29uc3QgY29sbGVjdGlvblJlZiA9IGNvbGxlY3Rpb24odGhpcy5kYiwgYmx1ZXByaW50LmJ1aWxkQ29sbGVjdGlvblJvdXRlKCkpLndpdGhDb252ZXJ0ZXIodGhpcy5nZXRDb252ZXJ0ZXI8VD4oYmx1ZXByaW50LmNvbnN0cnVjdG9yRnVuY3Rpb24pKVxyXG4gICAgY29uc3Qgd2hlcmVzOiBhbnlbXSA9IFtdXHJcbiAgICBxdWVyeVBhcmFtcy5mb3JFYWNoKHBhcmFtID0+IHtcclxuICAgICAgd2hlcmVzLnB1c2god2hlcmUocGFyYW0uZmllbGQsIHBhcmFtLm9wLCBwYXJhbS52YWx1ZSkpXHJcbiAgICB9KVxyXG5cclxuICAgIHRoaXMubGlzdGVuZXJzW25hbWVdID0gb25TbmFwc2hvdChxdWVyeShjb2xsZWN0aW9uUmVmLCAuLi53aGVyZXMpLCAoc25hcHNob3QpID0+IHtcclxuICAgICAgb25SZWNpZXZlKHNuYXBzaG90LmRvY3MubWFwKGQgPT4gZC5kYXRhKCkgYXMgVCkpXHJcbiAgICB9LCAoZXJyb3IpID0+IG9uRXJyb3IoZXJyb3IpKVxyXG4gIH1cclxuXHJcbiAgdW5zdWJzY3JpYmVMaXN0ZW5lcihuYW1lOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIGlmKHRoaXMubGlzdGVuZXJzW25hbWVdKXtcclxuICAgICAgdGhpcy5saXN0ZW5lcnNbbmFtZV0oKVxyXG4gICAgICBkZWxldGUgdGhpcy5saXN0ZW5lcnNbbmFtZV1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIGhhc0xpc3RlbmVyKG5hbWU6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIHRoaXMubGlzdGVuZXJzW25hbWVdICE9PSB1bmRlZmluZWRcclxuICB9XHJcblxyXG4gIGRlbGV0ZTxUIGV4dGVuZHMgTW9kZWw+KGJsdWVwcmludDogQmx1ZXByaW50PFQ+LCBpZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoYXN5bmMgKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICB0cnkge1xyXG4gICAgICAgIGlmKHRoaXMuYmF0Y2gpe1xyXG4gICAgICAgICAgYXdhaXQgdGhpcy5iYXRjaC5kZWxldGUoZG9jKHRoaXMuZGIsIGJsdWVwcmludC5idWlsZENvbGxlY3Rpb25Sb3V0ZSgpLCBpZCkpXHJcbiAgICAgICAgICByZXNvbHZlKClcclxuICAgICAgICB9IGVsc2UgaWYodGhpcy50cmFuc2FjdGlvbikge1xyXG4gICAgICAgICAgYXdhaXQgdGhpcy50cmFuc2FjdGlvbi5kZWxldGUoZG9jKHRoaXMuZGIsIGJsdWVwcmludC5idWlsZENvbGxlY3Rpb25Sb3V0ZSgpLCBpZCkpXHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGF3YWl0IGRlbGV0ZURvYyhkb2ModGhpcy5kYiwgYmx1ZXByaW50LmJ1aWxkQ29sbGVjdGlvblJvdXRlKCksIGlkKS53aXRoQ29udmVydGVyKHRoaXMuZ2V0Q29udmVydGVyPFQ+KGJsdWVwcmludC5jb25zdHJ1Y3RvckZ1bmN0aW9uKSkpXHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJlc29sdmUoKVxyXG4gICAgICB9IGNhdGNoKGUpIHtcclxuICAgICAgICByZWplY3QoZSlcclxuICAgICAgfVxyXG4gICAgfSlcclxuICB9XHJcblxyXG4gIGRlbGV0ZU1hbnk8VCBleHRlbmRzIE1vZGVsPihibHVlcHJpbnQ6IEJsdWVwcmludDxUPiwgaWRzOiBzdHJpbmdbXSk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgcmV0dXJuIChuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgY29uc3QgcHJvbWlzZXMgPSBpZHMubWFwKGlkID0+IHRoaXMuZGVsZXRlKGJsdWVwcmludCwgaWQpKVxyXG4gICAgICAgIFByb21pc2UuYWxsKHByb21pc2VzKS50aGVuKCgpID0+IHJlc29sdmUoKSkuY2F0Y2goZSA9PiByZWplY3QoZSkpXHJcbiAgICAgIH0gY2F0Y2goZSkge1xyXG4gICAgICAgIHJlamVjdChlKVxyXG4gICAgICB9XHJcbiAgICB9KSlcclxuICB9XHJcblxyXG4gIGNvbnZlcnRUb1RpbWVzdGFtcChkYXRlOiBEYXRlKTogVGltZXN0YW1we1xyXG4gICAgcmV0dXJuIFRpbWVzdGFtcC5mcm9tRGF0ZShkYXRlKVxyXG4gIH1cclxuXHJcbiAgY29udmVydEZyb21UaW1lc3RhbXAodGltZXN0YW1wOiBUaW1lc3RhbXApe1xyXG4gICAgaWYodHlwZW9mIHRpbWVzdGFtcC50b0RhdGUgPT09ICdmdW5jdGlvbicpe1xyXG4gICAgICByZXR1cm4gdGltZXN0YW1wLnRvRGF0ZSgpXHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gbmV3IERhdGUodGltZXN0YW1wLnNlY29uZHMgKiAxMDAwKVxyXG4gICAgfVxyXG4gIH1cclxuXHJcblxyXG4gIGdldENvbnZlcnRlcjxUIGV4dGVuZHMgTW9kZWw+KGNvbnN0cnVjdG9yOiBDb25zdHJ1Y3RvckZ1bmN0aW9uPFQ+KSB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICB0b0ZpcmVzdG9yZSAoaXRlbTogVCk6IERvY3VtZW50RGF0YSB7XHJcbiAgICAgICAgcmV0dXJuIGl0ZW0udG9Kc29uKHRydWUpXHJcbiAgICAgIH0sXHJcbiAgICAgIGZyb21GaXJlc3RvcmUgKFxyXG4gICAgICAgIHNuYXBzaG90OiBRdWVyeURvY3VtZW50U25hcHNob3Q8VD4sXHJcbiAgICAgICk6IFQge1xyXG4gICAgICAgIGNvbnN0IGRhdGEgPSBzbmFwc2hvdC5kYXRhKClcclxuICAgICAgICBkYXRhLmlkID0gc25hcHNob3QuaWRcclxuICAgICAgICByZXR1cm4gKG5ldyBjb25zdHJ1Y3RvcigpKS5mcm9tSnNvbihkYXRhLCB0cnVlKVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBhc3luYyBydW5UcmFuc2FjdGlvbihvcGVyYXRpb25zOiAoKCkgPT4gUHJvbWlzZTx2b2lkPikpOiBQcm9taXNlPGFueT4ge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgcnVuVHJhbnNhY3Rpb24odGhpcy5kYiwgYXN5bmMgdHJhbnNhY3Rpb24gPT4ge1xyXG4gICAgICAgIHRoaXMudHJhbnNhY3Rpb24gPSB0cmFuc2FjdGlvblxyXG4gICAgICAgIC8vIHRoaXMudHJhbnNhY3Rpb24uXHJcbiAgICAgICAgcmV0dXJuIG9wZXJhdGlvbnMoKVxyXG4gICAgICB9KS50aGVuKChyZXN1bHQpID0+IHtcclxuICAgICAgICB0aGlzLnRyYW5zYWN0aW9uID0gbnVsbFxyXG4gICAgICAgIHJlc29sdmUocmVzdWx0KVxyXG4gICAgICB9KS5jYXRjaChlID0+IHtcclxuICAgICAgICB0aGlzLnRyYW5zYWN0aW9uID0gbnVsbFxyXG4gICAgICAgIHJlamVjdChlKVxyXG4gICAgICB9KVxyXG4gICAgfSlcclxuICB9XHJcblxyXG4gIC8vVE9ETyBvdmVyIDUwMCBvcGVyYXRpb25zIHBlciB0cmFuc2FjdGlvbiBjaGVja1xyXG4gIGFzeW5jIHJ1bkJhdGNoKG9wZXJhdGlvbnM6ICgoKSA9PiBQcm9taXNlPHZvaWQ+KSk6IFByb21pc2U8YW55PiB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICB0aGlzLmJhdGNoID0gd3JpdGVCYXRjaCh0aGlzLmRiKVxyXG4gICAgICBvcGVyYXRpb25zKCkudGhlbigoKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuYmF0Y2guY29tbWl0KClcclxuICAgICAgfSkudGhlbigocmVzdWx0KSA9PiB7XHJcbiAgICAgICAgdGhpcy5iYXRjaCA9IG51bGxcclxuICAgICAgICByZXNvbHZlKHJlc3VsdClcclxuICAgICAgfSkuY2F0Y2goZSA9PiB7XHJcbiAgICAgICAgdGhpcy5iYXRjaCA9IG51bGxcclxuICAgICAgICByZWplY3QoZSlcclxuICAgICAgfSlcclxuICAgIH0pXHJcbiAgfVxyXG5cclxuICAvL1RPRE8gZGVsZXRlIG9wZXJhdGlvblxyXG59Il19